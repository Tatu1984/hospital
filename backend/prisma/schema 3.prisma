generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id        String    @id @default(uuid())
  name      String
  contact   String?
  address   String?
  config    Json?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  branches  Branch[]
  patients  Patient[]
  users     User[]

  @@map("tenants")
}

model Branch {
  id             String          @id @default(uuid())
  tenantId       String
  name           String
  type           String          @default("hospital")
  address        String?
  timezone       String          @default("Asia/Kolkata")
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  attendanceLogs AttendanceLog[]
  beds           Bed[]
  branchModules  BranchModule[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  departments    Department[]
  encounters     Encounter[]
  patients       Patient[]
  users          User[]

  @@map("branches")
}

model Module {
  id            String         @id @default(uuid())
  name          String
  code          String         @unique
  category      String
  isActive      Boolean        @default(true)
  branchModules BranchModule[]

  @@map("modules")
}

model BranchModule {
  id          String    @id @default(uuid())
  branchId    String
  moduleId    String
  isActive    Boolean   @default(false)
  activatedAt DateTime?
  userLimit   Int?
  branch      Branch    @relation(fields: [branchId], references: [id])
  module      Module    @relation(fields: [moduleId], references: [id])

  @@unique([branchId, moduleId])
  @@map("branch_modules")
}

model Department {
  id       String  @id @default(uuid())
  branchId String
  name     String
  type     String  @default("clinical")
  isActive Boolean @default(true)
  branch   Branch  @relation(fields: [branchId], references: [id])

  @@map("departments")
}

model User {
  id                String          @id @default(uuid())
  tenantId          String
  branchId          String
  username          String          @unique
  email             String          @unique
  passwordHash      String
  name              String
  roleIds           String[]
  departmentIds     String[]
  biometricTemplate String?
  isActive          Boolean         @default(true)
  lastLoginAt       DateTime?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  admissions        Admission[]     @relation("AdmittingDoctor")
  attendanceLogs    AttendanceLog[]
  performedAuditLog AuditLog[]      @relation("PerformedBy")
  createdAuditLogs  AuditLog[]      @relation("CreatedBy")
  appointments      Appointment[]   @relation("DoctorAppointments")
  encounters        Encounter[]
  opdNotes          OPDNote[]
  prescriptions     Prescription[]
  branch            Branch          @relation(fields: [branchId], references: [id])
  tenant            Tenant          @relation(fields: [tenantId], references: [id])

  @@map("users")
}

model Patient {
  id                String             @id @default(uuid())
  tenantId          String
  branchId          String
  mrn               String
  name              String
  dob               DateTime?
  gender            String?
  contact           String?
  email             String?
  address           String?
  photo             String?
  biometricTemplate String?
  emergencyContact  String?
  bloodGroup        String?
  allergies         String?
  referralSourceId  String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  admissions        Admission[]
  appointments      Appointment[]
  dietOrders        DietOrder[]
  encounters        Encounter[]
  feedbacks         Feedback[]
  incidents         Incident[]
  invoices          Invoice[]
  opdNotes          OPDNote[]
  orders            Order[]
  branch            Branch             @relation(fields: [branchId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  preAuths          PreAuthorization[]
  referralSource    ReferralSource?    @relation(fields: [referralSourceId], references: [id])
  commissions       Commission[]
  insurances        PatientInsurance[]
  documents         Document[]
  criticalAlerts    CriticalAlert[]

  @@unique([tenantId, mrn])
  @@map("patients")
}

model Appointment {
  id              String   @id @default(uuid())
  tenantId        String
  patientId       String
  doctorId        String
  appointmentDate DateTime
  appointmentTime String
  type            String   @default("consultation")
  status          String   @default("scheduled")
  reason          String?
  notes           String?
  department      String?
  createdBy       String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  patient         Patient  @relation(fields: [patientId], references: [id])
  doctor          User     @relation("DoctorAppointments", fields: [doctorId], references: [id])

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
  @@map("appointments")
}

model Encounter {
  id             String     @id @default(uuid())
  patientId      String
  branchId       String
  type           String
  visitDate      DateTime   @default(now())
  doctorId       String?
  status         String     @default("active")
  chiefComplaint String?
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
  admission      Admission?
  branch         Branch     @relation(fields: [branchId], references: [id])
  doctor         User?      @relation(fields: [doctorId], references: [id])
  patient        Patient    @relation(fields: [patientId], references: [id])
  invoices       Invoice[]
  opdNotes       OPDNote[]
  orders         Order[]

  @@map("encounters")
}

model Admission {
  id                String    @id @default(uuid())
  encounterId       String    @unique
  patientId         String
  admissionDate     DateTime  @default(now())
  dischargeDate     DateTime?
  bedId             String?
  admittingDoctorId String?
  status            String    @default("active")
  diagnosis         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  admittingDoctor   User?     @relation("AdmittingDoctor", fields: [admittingDoctorId], references: [id])
  bed               Bed?      @relation(fields: [bedId], references: [id])
  encounter         Encounter @relation(fields: [encounterId], references: [id])
  patient           Patient   @relation(fields: [patientId], references: [id])
  ipdNotes          IPDNote[]

  @@map("admissions")
}

model Bed {
  id         String      @id @default(uuid())
  branchId   String
  wardId     String?
  bedNumber  String
  category   String      @default("general")
  status     String      @default("vacant")
  floor      String?
  admissions Admission[]
  branch     Branch      @relation(fields: [branchId], references: [id])

  @@unique([branchId, bedNumber])
  @@map("beds")
}

model OPDNote {
  id             String         @id @default(uuid())
  encounterId    String
  patientId      String
  doctorId       String
  chiefComplaint String?
  history        String?
  vitals         Json?
  examination    String?
  assessment     String?
  plan           String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  doctor         User           @relation(fields: [doctorId], references: [id])
  encounter      Encounter      @relation(fields: [encounterId], references: [id])
  patient        Patient        @relation(fields: [patientId], references: [id])
  prescriptions  Prescription[]

  @@map("opd_notes")
}

model Prescription {
  id        String   @id @default(uuid())
  opdNoteId String
  doctorId  String
  drugs     Json
  createdAt DateTime @default(now())
  doctor    User     @relation(fields: [doctorId], references: [id])
  opdNote   OPDNote  @relation(fields: [opdNoteId], references: [id])

  @@map("prescriptions")
}

model IPDNote {
  id          String    @id @default(uuid())
  admissionId String
  noteType    String
  note        String
  authorId    String?
  createdAt   DateTime  @default(now())
  admission   Admission @relation(fields: [admissionId], references: [id])

  @@map("ipd_notes")
}

model Order {
  id          String     @id @default(uuid())
  patientId   String
  encounterId String?
  orderType   String
  orderedBy   String
  orderedAt   DateTime   @default(now())
  status      String     @default("pending")
  details     Json
  priority    String     @default("routine")
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  encounter   Encounter? @relation(fields: [encounterId], references: [id])
  patient     Patient    @relation(fields: [patientId], references: [id])
  results     Result[]

  @@map("orders")
}

model Result {
  id         String   @id @default(uuid())
  orderId    String
  resultData Json
  resultedAt DateTime @default(now())
  verifiedBy String?
  isCritical Boolean  @default(false)
  createdAt  DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id])

  @@map("results")
}

model CriticalAlert {
  id               String   @id @default(uuid())
  orderId          String
  resultId         String?
  patientId        String
  testName         String
  value            String
  unit             String?
  normalRange      String?
  alertedAt        DateTime @default(now())
  acknowledgedAt   DateTime?
  acknowledgedBy   String?
  status           String   @default("unacknowledged") // unacknowledged, acknowledged
  notifiedDoctorId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  patient          Patient  @relation(fields: [patientId], references: [id])

  @@map("critical_alerts")
}

model Invoice {
  id               String       @id @default(uuid())
  patientId        String
  encounterId      String?
  type             String
  items            Json
  subtotal         Decimal      @db.Decimal(10, 2)
  discount         Decimal      @default(0) @db.Decimal(10, 2)
  tax              Decimal      @default(0) @db.Decimal(10, 2)
  total            Decimal      @db.Decimal(10, 2)
  paid             Decimal      @default(0) @db.Decimal(10, 2)
  balance          Decimal      @db.Decimal(10, 2)
  status           String       @default("draft")
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  encounter        Encounter?   @relation(fields: [encounterId], references: [id])
  patient          Patient      @relation(fields: [patientId], references: [id])
  payments         Payment[]
  commissions      Commission[]
  journalEntries   JournalEntry[]
  doctorRevenues   DoctorRevenue[]

  @@map("invoices")
}

model Payment {
  id                 String   @id @default(uuid())
  invoiceId          String
  amount             Decimal  @db.Decimal(10, 2)
  mode               String   // cash, card, upi, netbanking, razorpay, etc.
  transactionRef     String?
  paidAt             DateTime @default(now())
  receivedBy         String?
  createdAt          DateTime @default(now())
  invoice            Invoice  @relation(fields: [invoiceId], references: [id])

  // Razorpay specific fields
  razorpayOrderId    String?  @unique
  razorpayPaymentId  String?  @unique
  razorpaySignature  String?
  gatewayStatus      String?  // initiated, captured, failed, refunded
  gatewayResponse    Json?    // Full gateway response for debugging
  refundId           String?  // For refund tracking
  refundAmount       Decimal? @db.Decimal(10, 2)
  refundedAt         DateTime?

  @@map("payments")
}

model AttendanceLog {
  id        String   @id @default(uuid())
  userId    String
  branchId  String
  deviceId  String?
  punchTime DateTime @default(now())
  punchType String
  location  String?
  createdAt DateTime @default(now())
  branch    Branch   @relation(fields: [branchId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("attendance_logs")
}

model Feedback {
  id         String   @id @default(uuid())
  patientId  String?
  type       String
  message    String
  resolution String?
  status     String   @default("pending")
  reportedBy String?
  resolvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  patient    Patient? @relation(fields: [patientId], references: [id])

  @@map("feedbacks")
}

model AuditLog {
  id              String   @id @default(uuid())
  userId          String?
  action          String
  resource        String
  resourceId      String?
  oldValue        Json?
  newValue        Json?
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime @default(now())
  performedBy     String?
  performedByUser User?    @relation("PerformedBy", fields: [performedBy], references: [id])
  user            User?    @relation("CreatedBy", fields: [userId], references: [id])

  @@map("audit_logs")
}

model Drug {
  id            String          @id @default(uuid())
  name          String
  genericName   String
  form          String
  strength      String
  category      String
  isNarcotic    Boolean         @default(false)
  price         Decimal         @db.Decimal(10, 2)
  isActive      Boolean         @default(true)
  code          String?         @unique
  reorderLevel  Int             @default(10)
  stockQuantity Int             @default(0)
  stocks        PharmacyStock[]

  @@map("drugs")
}

model PharmacyStock {
  id            String   @id @default(uuid())
  drugId        String
  batchNumber   String
  expiryDate    DateTime
  quantity      Int
  purchasePrice Decimal  @db.Decimal(10, 2)
  mrp           Decimal  @db.Decimal(10, 2)
  supplierId    String?
  supplierName  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  drug          Drug     @relation(fields: [drugId], references: [id])

  @@map("pharmacy_stocks")
}

model PharmacySale {
  id            String              @id @default(uuid())
  invoiceNumber String              @unique
  patientName   String?
  patientMRN    String?
  patientId     String?
  total         Decimal             @db.Decimal(10, 2)
  paymentMode   String              @default("cash")
  items         PharmacySaleItem[]
  createdBy     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  @@map("pharmacy_sales")
}

model PharmacySaleItem {
  id          String        @id @default(uuid())
  saleId      String
  drugId      String
  drugName    String
  batchNumber String?
  quantity    Int
  unitPrice   Decimal       @db.Decimal(10, 2)
  total       Decimal       @db.Decimal(10, 2)
  sale        PharmacySale  @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("pharmacy_sale_items")
}

model LabTestMaster {
  id          String  @id @default(uuid())
  name        String
  code        String  @unique
  category    String
  price       Decimal @db.Decimal(10, 2)
  tat         Int
  unit        String?
  normalRange String?
  isActive    Boolean @default(true)

  @@map("lab_test_master")
}

model RadiologyTestMaster {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  modality String
  price    Decimal @db.Decimal(10, 2)
  tat      Int
  isActive Boolean @default(true)

  @@map("radiology_test_master")
}

model ProcedureMaster {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  category String
  price    Decimal @db.Decimal(10, 2)
  isActive Boolean @default(true)

  @@map("procedure_master")
}

model PackageMaster {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  items    Json
  price    Decimal @db.Decimal(10, 2)
  isActive Boolean @default(true)

  @@map("package_master")
}

model Ward {
  id           String  @id @default(uuid())
  name         String
  type         String
  floor        String?
  totalBeds    Int
  tariffPerDay Decimal @db.Decimal(10, 2)
  isActive     Boolean @default(true)

  @@map("wards")
}

model OTTheatre {
  id        String  @id @default(uuid())
  name      String
  type      String
  floor     String?
  equipment Json?
  isActive  Boolean @default(true)

  @@map("ot_theatres")
}

model TPAMaster {
  id              String             @id @default(uuid())
  name            String
  type            String
  contactPerson   String?
  contact         String?
  email           String?
  address         String?
  creditLimit     Decimal?           @db.Decimal(12, 2)
  discountPercent Decimal?           @db.Decimal(5, 2)
  isActive          Boolean            @default(true)
  preAuths          PreAuthorization[]
  patientInsurances PatientInsurance[]

  @@map("tpa_master")
}

model PreAuthorization {
  id               String    @id @default(uuid())
  patientId        String
  tpaId            String
  requestDate      DateTime  @default(now())
  approvalDate     DateTime?
  status           String    @default("pending")
  requestedAmount  Decimal   @db.Decimal(10, 2)
  approvedAmount   Decimal?  @db.Decimal(10, 2)
  diagnosis        String?
  procedurePlanned String?
  remarks          String?
  approvalNumber   String?
  validTill        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  patient          Patient   @relation(fields: [patientId], references: [id])
  tpa              TPAMaster @relation(fields: [tpaId], references: [id])

  @@map("pre_authorizations")
}

model PatientInsurance {
  id               String    @id @default(uuid())
  patientId        String
  tpaId            String
  policyNumber     String
  policyHolderName String?
  validFrom        DateTime
  validTill        DateTime
  sumInsured       Decimal   @db.Decimal(12, 2)
  isActive         Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  patient          Patient   @relation(fields: [patientId], references: [id])
  tpa              TPAMaster @relation(fields: [tpaId], references: [id])

  @@map("patient_insurances")
}

model InventoryItem {
  id                 String              @id @default(uuid())
  name               String
  code               String              @unique
  category           String
  unit               String
  reorderLevel       Int                 @default(0)
  price              Decimal             @db.Decimal(10, 2)
  isActive           Boolean             @default(true)
  purchaseOrderItems PurchaseOrderItem[]
  stocks             Stock[]

  @@map("inventory_items")
}

model Stock {
  id          String        @id @default(uuid())
  itemId      String
  storeId     String
  batchNumber String?
  expiryDate  DateTime?
  quantity    Int
  lastUpdated DateTime      @updatedAt
  item        InventoryItem @relation(fields: [itemId], references: [id])

  @@map("stocks")
}

model PurchaseOrder {
  id            String              @id @default(uuid())
  poNumber      String              @unique
  vendorName    String
  vendorContact String?
  orderDate     DateTime            @default(now())
  expectedDate  DateTime?
  status        String              @default("pending")
  totalAmount   Decimal             @db.Decimal(12, 2)
  remarks       String?
  createdBy     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  items         PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id            String        @id @default(uuid())
  poId          String
  itemId        String
  quantity      Int
  rate          Decimal       @db.Decimal(10, 2)
  amount        Decimal       @db.Decimal(10, 2)
  item          InventoryItem @relation(fields: [itemId], references: [id])
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])

  @@map("purchase_order_items")
}

model HousekeepingTask {
  id          String    @id @default(uuid())
  bedId       String?
  taskType    String
  assignedTo  String?
  status      String    @default("pending")
  priority    String    @default("normal")
  scheduledAt DateTime?
  completedAt DateTime?
  remarks     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("housekeeping_tasks")
}

model DietOrder {
  id          String   @id @default(uuid())
  patientId   String
  admissionId String?
  dietType    String
  mealType    String
  orderDate   DateTime @default(now())
  status      String   @default("pending")
  remarks     String?
  patient     Patient  @relation(fields: [patientId], references: [id])

  @@map("diet_orders")
}

model Asset {
  id              String           @id @default(uuid())
  name            String
  assetCode       String           @unique
  category        String
  location        String?
  purchaseDate    DateTime?
  warrantyExpiry  DateTime?
  amcVendor       String?
  amcExpiry       DateTime?
  status          String           @default("active")
  isActive        Boolean          @default(true)
  maintenanceLogs MaintenanceLog[]

  @@map("assets")
}

model MaintenanceLog {
  id              String    @id @default(uuid())
  assetId         String
  maintenanceType String
  scheduledDate   DateTime?
  completedDate   DateTime?
  technician      String?
  findings        String?
  actionTaken     String?
  cost            Decimal?  @db.Decimal(10, 2)
  status          String    @default("scheduled")
  createdAt       DateTime  @default(now())
  asset           Asset     @relation(fields: [assetId], references: [id])

  @@map("maintenance_logs")
}

model AmbulanceTrip {
  id             String    @id @default(uuid())
  vehicleNumber  String
  driverName     String?
  driverContact  String?
  patientId      String?
  pickupLocation String
  dropLocation   String
  tripType       String
  startTime      DateTime  @default(now())
  endTime        DateTime?
  distance       Decimal?  @db.Decimal(6, 2)
  charges        Decimal?  @db.Decimal(10, 2)
  status         String    @default("in_progress")
  remarks        String?
  createdAt      DateTime  @default(now())

  @@map("ambulance_trips")
}

model Incident {
  id            String    @id @default(uuid())
  type          String
  severity      String
  patientId     String?
  location      String?
  description   String
  reportedBy    String?
  reportedAt    DateTime  @default(now())
  investigation String?
  rootCause     String?
  actionTaken   String?
  status        String    @default("reported")
  closedAt      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  patient       Patient?  @relation(fields: [patientId], references: [id])

  @@map("incidents")
}

// ===========================
// BROKER/REFERRAL COMMISSION SYSTEM
// ===========================

model ReferralSource {
  id                 String              @id @default(uuid())
  tenantId           String
  code               String              @unique
  name               String
  type               String              // broker, agent, doctor, hospital, corporate, self
  contact            String?
  email              String?
  address            String?
  commissionType     String              @default("percentage") // percentage, fixed, tiered
  commissionValue    Decimal             @default(0) @db.Decimal(5, 2) // percentage or fixed amount
  commissionTiers    Json?               // for tiered commission: [{min: 0, max: 10000, value: 5}, {min: 10000, max: null, value: 10}]
  paymentTerms       String?             // payment terms description
  bankName           String?
  accountNumber      String?
  ifscCode           String?
  panNumber          String?
  gstNumber          String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  patients           Patient[]
  commissions        Commission[]
  commissionPayouts  CommissionPayout[]

  @@map("referral_sources")
}

model Commission {
  id                  String             @id @default(uuid())
  referralSourceId    String
  patientId           String
  invoiceId           String
  invoiceAmount       Decimal            @db.Decimal(10, 2)
  commissionType      String             // percentage, fixed
  commissionRate      Decimal?           @db.Decimal(5, 2) // percentage rate if applicable
  commissionAmount    Decimal            @db.Decimal(10, 2)
  status              String             @default("pending") // pending, approved, paid, cancelled
  approvedBy          String?
  approvedAt          DateTime?
  paidAt              DateTime?
  payoutId            String?
  remarks             String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  referralSource      ReferralSource     @relation(fields: [referralSourceId], references: [id])
  patient             Patient            @relation(fields: [patientId], references: [id])
  invoice             Invoice            @relation(fields: [invoiceId], references: [id])
  payout              CommissionPayout?  @relation(fields: [payoutId], references: [id])

  @@index([referralSourceId])
  @@index([status])
  @@map("commissions")
}

model CommissionPayout {
  id                 String           @id @default(uuid())
  referralSourceId   String
  payoutNumber       String           @unique
  fromDate           DateTime
  toDate             DateTime
  totalAmount        Decimal          @db.Decimal(12, 2)
  paymentMode        String           // cash, cheque, bank_transfer, upi
  paymentReference   String?
  paymentDate        DateTime         @default(now())
  paidBy             String?
  remarks            String?
  status             String           @default("processed") // processed, cancelled
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  referralSource     ReferralSource   @relation(fields: [referralSourceId], references: [id])
  commissions        Commission[]

  @@map("commission_payouts")
}

// ===========================
// ACCOUNTS SYSTEM
// ===========================

model FiscalYear {
  id             String         @id @default(uuid())
  tenantId       String
  name           String         // FY 2024-25
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean        @default(true)
  isClosed       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  journalEntries JournalEntry[]

  @@unique([tenantId, name])
  @@map("fiscal_years")
}

model AccountGroup {
  id           String        @id @default(uuid())
  tenantId     String
  name         String
  code         String        @unique
  type         String        // asset, liability, income, expense, equity
  parentId     String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  parent       AccountGroup? @relation("GroupHierarchy", fields: [parentId], references: [id])
  children     AccountGroup[] @relation("GroupHierarchy")
  accountHeads AccountHead[]

  @@map("account_groups")
}

model AccountHead {
  id                  String              @id @default(uuid())
  tenantId            String
  groupId             String
  name                String
  code                String              @unique
  type                String              // asset, liability, income, expense, equity
  subType             String?             // current_asset, fixed_asset, current_liability, etc.
  openingBalance      Decimal             @default(0) @db.Decimal(12, 2)
  currentBalance      Decimal             @default(0) @db.Decimal(12, 2)
  isSystemAccount     Boolean             @default(false) // cannot be deleted
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  group               AccountGroup        @relation(fields: [groupId], references: [id])
  journalEntryLines   JournalEntryLine[]
  ledgerEntries       LedgerEntry[]

  @@map("account_heads")
}

model JournalEntry {
  id              String             @id @default(uuid())
  tenantId        String
  fiscalYearId    String
  entryNumber     String             @unique
  entryDate       DateTime           @default(now())
  entryType       String             // manual, automatic, opening, closing, adjustment
  referenceType   String?            // invoice, payment, salary, purchase, etc.
  referenceId     String?            // ID of the related entity
  description     String
  totalDebit      Decimal            @db.Decimal(12, 2)
  totalCredit     Decimal            @db.Decimal(12, 2)
  isPosted        Boolean            @default(false)
  postedAt        DateTime?
  postedBy        String?
  createdBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  fiscalYear      FiscalYear         @relation(fields: [fiscalYearId], references: [id])
  invoice         Invoice?           @relation(fields: [referenceId], references: [id])
  lines           JournalEntryLine[]
  ledgerEntries   LedgerEntry[]

  @@index([referenceType, referenceId])
  @@map("journal_entries")
}

model JournalEntryLine {
  id              String        @id @default(uuid())
  journalEntryId  String
  accountHeadId   String
  description     String?
  debitAmount     Decimal       @default(0) @db.Decimal(12, 2)
  creditAmount    Decimal       @default(0) @db.Decimal(12, 2)
  createdAt       DateTime      @default(now())
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  accountHead     AccountHead   @relation(fields: [accountHeadId], references: [id])

  @@map("journal_entry_lines")
}

model LedgerEntry {
  id              String        @id @default(uuid())
  tenantId        String
  accountHeadId   String
  journalEntryId  String
  entryDate       DateTime
  description     String
  debitAmount     Decimal       @default(0) @db.Decimal(12, 2)
  creditAmount    Decimal       @default(0) @db.Decimal(12, 2)
  runningBalance  Decimal       @db.Decimal(12, 2)
  createdAt       DateTime      @default(now())
  accountHead     AccountHead   @relation(fields: [accountHeadId], references: [id])
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id])

  @@index([accountHeadId, entryDate])
  @@map("ledger_entries")
}

// ===========================
// DOCTOR REVENUE SHARING SYSTEM
// ===========================

model DoctorContract {
  id                    String          @id @default(uuid())
  doctorId              String          @unique
  contractNumber        String          @unique
  startDate             DateTime
  endDate               DateTime?
  revenueShareType      String          // percentage, fixed_per_consultation, tiered
  revenueShareValue     Decimal         @db.Decimal(5, 2) // percentage or fixed amount
  revenueTiers          Json?           // for tiered: [{min: 0, max: 100000, value: 30}, {min: 100000, max: null, value: 40}]
  consultationFeeShare  Decimal?        @db.Decimal(5, 2) // percentage share of consultation fees
  procedureFeeShare     Decimal?        @db.Decimal(5, 2) // percentage share of procedure fees
  paymentCycle          String          @default("monthly") // daily, weekly, monthly, quarterly
  bankName              String?
  accountNumber         String?
  ifscCode              String?
  panNumber             String?
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  doctorRevenues        DoctorRevenue[]
  doctorPayouts         DoctorPayout[]

  @@map("doctor_contracts")
}

model DoctorRevenue {
  id                  String           @id @default(uuid())
  contractId          String
  doctorId            String
  invoiceId           String
  patientId           String
  revenueType         String           // consultation, procedure, investigation
  revenueAmount       Decimal          @db.Decimal(10, 2)
  shareType           String           // percentage, fixed
  shareRate           Decimal?         @db.Decimal(5, 2)
  shareAmount         Decimal          @db.Decimal(10, 2)
  status              String           @default("pending") // pending, approved, paid
  approvedBy          String?
  approvedAt          DateTime?
  paidAt              DateTime?
  payoutId            String?
  remarks             String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  contract            DoctorContract   @relation(fields: [contractId], references: [id])
  invoice             Invoice          @relation(fields: [invoiceId], references: [id])
  payout              DoctorPayout?    @relation(fields: [payoutId], references: [id])

  @@index([doctorId])
  @@index([status])
  @@map("doctor_revenues")
}

model DoctorPayout {
  id              String          @id @default(uuid())
  contractId      String
  doctorId        String
  payoutNumber    String          @unique
  fromDate        DateTime
  toDate          DateTime
  totalRevenue    Decimal         @db.Decimal(12, 2)
  totalShare      Decimal         @db.Decimal(12, 2)
  deductions      Decimal         @default(0) @db.Decimal(12, 2)
  netAmount       Decimal         @db.Decimal(12, 2)
  paymentMode     String          // cash, cheque, bank_transfer, upi
  paymentReference String?
  paymentDate     DateTime        @default(now())
  paidBy          String?
  remarks         String?
  status          String          @default("processed") // processed, cancelled
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  contract        DoctorContract  @relation(fields: [contractId], references: [id])
  revenues        DoctorRevenue[]

  @@map("doctor_payouts")
}

// ===========================
// BLOOD BANK SYSTEM
// ===========================

model BloodDonor {
  id              String           @id @default(uuid())
  donorId         String           @unique
  name            String
  age             Int
  gender          String
  bloodType       String
  phone           String
  email           String?
  address         String?
  lastDonationAt  DateTime?
  totalDonations  Int              @default(0)
  isEligible      Boolean          @default(true)
  screeningStatus String           @default("pending") // pending, cleared, rejected
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  donations       BloodDonation[]

  @@map("blood_donors")
}

model BloodDonation {
  id              String         @id @default(uuid())
  donorId         String
  donationDate    DateTime       @default(now())
  bloodType       String
  component       String         @default("whole_blood")
  volume          Int            @default(450) // ml
  bagNumber       String         @unique
  collectedBy     String?
  status          String         @default("collected") // collected, processed, available, expired, discarded
  expiryDate      DateTime
  createdAt       DateTime       @default(now())
  donor           BloodDonor     @relation(fields: [donorId], references: [id])
  inventory       BloodInventory?

  @@map("blood_donations")
}

model BloodInventory {
  id              String          @id @default(uuid())
  donationId      String?         @unique
  bloodType       String
  component       String
  bagNumber       String          @unique
  volume          Int
  collectionDate  DateTime
  expiryDate      DateTime
  status          String          @default("available") // available, reserved, issued, expired, discarded
  location        String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  donation        BloodDonation?  @relation(fields: [donationId], references: [id])
  issuances       BloodIssuance[]

  @@index([bloodType, component, status])
  @@map("blood_inventory")
}

model BloodRequest {
  id                String          @id @default(uuid())
  patientId         String?
  patientName       String
  patientMRN        String?
  bloodType         String
  component         String
  unitsRequested    Int
  urgency           String          @default("routine") // routine, urgent, emergency
  indication        String?
  requestedBy       String?
  requestedAt       DateTime        @default(now())
  crossMatchedAt    DateTime?
  crossMatchedBy    String?
  crossMatchResult  String?         // compatible, incompatible
  status            String          @default("pending") // pending, crossmatched, approved, issued, cancelled
  remarks           String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  issuances         BloodIssuance[]

  @@map("blood_requests")
}

model BloodIssuance {
  id              String          @id @default(uuid())
  requestId       String
  inventoryId     String
  issuedAt        DateTime        @default(now())
  issuedBy        String?
  receivedBy      String?
  status          String          @default("issued") // issued, returned, transfused
  remarks         String?
  createdAt       DateTime        @default(now())
  request         BloodRequest    @relation(fields: [requestId], references: [id])
  inventory       BloodInventory  @relation(fields: [inventoryId], references: [id])

  @@map("blood_issuances")
}

// ===========================
// HR & EMPLOYEE MANAGEMENT
// ===========================

model Employee {
  id              String    @id @default(uuid())
  employeeId      String    @unique
  name            String
  email           String?
  phone           String?
  department      String?
  designation     String?
  joiningDate     DateTime?
  salary          Decimal?  @db.Decimal(12, 2)
  status          String    @default("active") // active, on_leave, terminated
  shift           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  leaves          LeaveRequest[]
  attendances     EmployeeAttendance[]

  @@map("employees")
}

model EmployeeAttendance {
  id          String    @id @default(uuid())
  employeeId  String
  date        DateTime  @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  status      String    @default("present") // present, absent, half_day, on_leave
  remarks     String?
  createdAt   DateTime  @default(now())
  employee    Employee  @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@map("employee_attendances")
}

model LeaveRequest {
  id          String    @id @default(uuid())
  employeeId  String
  leaveType   String    // sick, casual, earned, maternity, etc.
  fromDate    DateTime
  toDate      DateTime
  reason      String?
  status      String    @default("pending") // pending, approved, rejected
  approvedBy  String?
  approvedAt  DateTime?
  remarks     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  employee    Employee  @relation(fields: [employeeId], references: [id])

  @@map("leave_requests")
}

// ===========================
// AMBULANCE MANAGEMENT
// ===========================

model AmbulanceVehicle {
  id              String    @id @default(uuid())
  vehicleNumber   String    @unique
  type            String    // ALS, BLS, patient_transport
  driverName      String?
  driverPhone     String?
  status          String    @default("available") // available, on_trip, maintenance, out_of_service
  lastMaintenance DateTime?
  currentLocation String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("ambulance_vehicles")
}

// ===========================
// EMERGENCY CASE TRACKING
// ===========================

model EmergencyCase {
  id              String    @id @default(uuid())
  patientId       String?
  patientName     String
  patientAge      Int?
  patientGender   String?
  patientContact  String?
  arrivalTime     DateTime  @default(now())
  triageCategory  String    // RED, YELLOW, GREEN
  chiefComplaint  String?
  vitalSigns      Json?
  isMLC           Boolean   @default(false)
  mlcNumber       String?
  assignedDoctor  String?
  status          String    @default("active") // active, admitted, discharged, transferred
  disposition     String?   // admitted_ipd, admitted_icu, discharged, transferred, dama, expired
  dischargeTime   DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("emergency_cases")
}

// ===========================
// ICU MANAGEMENT
// ===========================

model ICUBed {
  id              String        @id @default(uuid())
  bedNumber       String        @unique
  icuUnit         String        // MICU, SICU, NICU, PICU, CCU
  status          String        @default("vacant") // vacant, occupied, maintenance
  currentPatient  String?
  admissionId     String?
  ventilatorId    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  vitalsRecords   ICUVitals[]

  @@map("icu_beds")
}

model ICUVitals {
  id              String    @id @default(uuid())
  icuBedId        String
  patientId       String?
  heartRate       Int?
  systolicBP      Int?
  diastolicBP     Int?
  temperature     Decimal?  @db.Decimal(4, 1)
  spo2            Int?
  respiratoryRate Int?
  gcs             Int?
  ventilatorMode  String?
  fio2            Int?
  peep            Int?
  recordedAt      DateTime  @default(now())
  recordedBy      String?
  icuBed          ICUBed    @relation(fields: [icuBedId], references: [id])

  @@map("icu_vitals")
}

// ===========================
// SURGERY/OT MANAGEMENT
// ===========================

model Surgery {
  id              String    @id @default(uuid())
  patientId       String?
  patientName     String
  patientMRN      String?
  procedureName   String
  surgeonId       String?
  surgeonName     String
  anesthetistId   String?
  anesthetistName String?
  otRoomId        String?
  otRoom          String?
  scheduledDate   DateTime
  scheduledTime   String?
  estimatedDuration Int?    // minutes
  actualStartTime DateTime?
  actualEndTime   DateTime?
  anesthesiaType  String?
  priority        String    @default("elective") // emergency, urgent, elective
  status          String    @default("scheduled") // scheduled, in_progress, completed, cancelled, postponed
  preOpChecklist  Boolean   @default(false)
  postOpNotes     String?
  complications   String?
  implants        Json?
  consumables     Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("surgeries")
}

model OTRoom {
  id              String    @id @default(uuid())
  name            String    @unique
  type            String    // general, cardiac, neuro, orthopedic, etc.
  floor           String?
  status          String    @default("available") // available, in_use, cleaning, maintenance
  currentSurgery  String?
  equipment       Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("ot_rooms")
}

model Document {
  id            String    @id @default(uuid())
  tenantId      String
  patientId     String
  filename      String
  originalName  String
  mimeType      String
  size          Int
  category      String    // id_proof, insurance, medical_records, lab_reports, radiology, prescription, consent_form, discharge_summary, referral_letter, other
  description   String?
  path          String
  uploadedBy    String
  uploadedAt    DateTime  @default(now())
  isDeleted     Boolean   @default(false)
  patient       Patient   @relation(fields: [patientId], references: [id])

  @@map("documents")
}

model Notification {
  id            String    @id @default(uuid())
  tenantId      String
  type          String    // APPOINTMENT_REMINDER, APPOINTMENT_CONFIRMATION, LAB_RESULT, etc.
  message       String
  userId        String?   // Optional: the user this notification is for
  referenceId   String?   // The ID of the related entity (appointment, order, etc.)
  referenceType String?   // appointment, order, patient, etc.
  channel       String?   // sms, email, both, push
  status        String    @default("pending") // pending, sent, failed, delivered
  sentAt        DateTime?
  createdAt     DateTime  @default(now())

  @@index([tenantId, type])
  @@index([referenceId])
  @@map("notifications")
}

// ===========================
// INSURANCE CLAIMS & SETTLEMENTS
// ===========================

model Claim {
  id                    String       @id @default(uuid())
  tenantId              String
  claimNumber           String       @unique
  patientId             String
  patientInsuranceId    String?
  insuranceCompanyId    String?      // Reference to TPAMaster
  invoiceId             String?      // Link to invoice if claim is from invoice
  admissionId           String?
  claimType             String       // cashless, reimbursement
  claimAmount           Decimal      @db.Decimal(12, 2)
  approvedAmount        Decimal      @default(0) @db.Decimal(12, 2)
  rejectedAmount        Decimal      @default(0) @db.Decimal(12, 2)
  status                String       @default("submitted") // submitted, under_review, approved, rejected, settled
  submittedDate         DateTime     @default(now())
  approvedDate          DateTime?
  rejectedDate          DateTime?
  settledDate           DateTime?
  documents             Json?        // Array of document URLs/paths
  remarks               String?
  rejectionReason       String?
  createdBy             String?
  updatedBy             String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  settlements           Settlement[]

  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@index([claimNumber])
  @@map("claims")
}

model Settlement {
  id                String   @id @default(uuid())
  tenantId          String
  settlementNumber  String   @unique
  claimId           String
  claim             Claim    @relation(fields: [claimId], references: [id])
  settlementAmount  Decimal  @db.Decimal(12, 2)
  settlementDate    DateTime @default(now())
  paymentMode       String   // cheque, neft, rtgs, upi, cash
  transactionRef    String?  // Cheque number, transaction ID, etc.
  remarks           String?
  settledBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
  @@index([claimId])
  @@map("settlements")
}

// ===========================
// NURSING MODULE
// ===========================

model DutyRoster {
  id          String    @id @default(uuid())
  tenantId    String
  branchId    String
  nurseId     String
  nurseName   String
  date        DateTime  @db.Date
  shift       String    // morning, evening, night
  ward        String?
  department  String?
  status      String    @default("assigned") // assigned, completed, cancelled
  notes       String?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([nurseId, date, shift])
  @@index([branchId, date])
  @@index([nurseId])
  @@map("duty_rosters")
}

model MedicationAdministration {
  id                String    @id @default(uuid())
  tenantId          String
  branchId          String
  patientId         String
  admissionId       String?
  medicationName    String
  dosage            String
  route             String    // oral, IV, IM, subcutaneous, etc.
  frequency         String
  scheduledTime     DateTime
  administeredTime  DateTime?
  administeredBy    String?   // Nurse ID
  administeredByName String?
  status            String    @default("pending") // pending, administered, missed, refused
  notes             String?
  sideEffects       String?
  createdBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([patientId, status])
  @@index([admissionId])
  @@index([scheduledTime])
  @@map("medication_administrations")
}

model HandoverNote {
  id           String    @id @default(uuid())
  tenantId     String
  branchId     String
  shift        String    // morning, evening, night
  date         DateTime  @db.Date
  ward         String?
  department   String?
  handoverFrom String?   // Nurse ID who is handing over
  handoverTo   String?   // Nurse ID who is receiving
  patientId    String?
  patientName  String?
  admissionId  String?
  notes        String
  priority     String    @default("normal") // normal, high, critical
  status       String    @default("active") // active, acknowledged, archived
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([branchId, date, shift])
  @@index([patientId])
  @@map("handover_notes")
}

model NursingVitals {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  patientId       String
  admissionId     String?
  heartRate       Int?
  systolicBP      Int?
  diastolicBP     Int?
  temperature     Decimal?  @db.Decimal(4, 1)
  spo2            Int?
  respiratoryRate Int?
  weight          Decimal?  @db.Decimal(5, 2)
  height          Decimal?  @db.Decimal(5, 2)
  bmi             Decimal?  @db.Decimal(4, 2)
  painScore       Int?      // 0-10 pain scale
  consciousness   String?   // alert, drowsy, unconscious
  notes           String?
  recordedAt      DateTime  @default(now())
  recordedBy      String?   // Nurse ID
  recordedByName  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([patientId, recordedAt])
  @@index([admissionId])
  @@map("nursing_vitals")
}
