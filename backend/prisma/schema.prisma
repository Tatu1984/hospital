generator client {
  provider = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Tenant {
  id        String    @id @default(uuid())
  name      String
  contact   String?
  address   String?
  config    Json?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  branches  Branch[]
  patients  Patient[]
  users     User[]

  @@map("tenants")
}

model Branch {
  id             String          @id @default(uuid())
  tenantId       String
  name           String
  type           String          @default("hospital")
  address        String?
  timezone       String          @default("Asia/Kolkata")
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  attendanceLogs AttendanceLog[]
  beds           Bed[]
  branchModules  BranchModule[]
  tenant         Tenant          @relation(fields: [tenantId], references: [id])
  departments    Department[]
  encounters     Encounter[]
  patients       Patient[]
  users          User[]

  @@map("branches")
}

model Module {
  id            String         @id @default(uuid())
  name          String
  code          String         @unique
  category      String
  isActive      Boolean        @default(true)
  branchModules BranchModule[]

  @@map("modules")
}

model BranchModule {
  id          String    @id @default(uuid())
  branchId    String
  moduleId    String
  isActive    Boolean   @default(false)
  activatedAt DateTime?
  userLimit   Int?
  branch      Branch    @relation(fields: [branchId], references: [id])
  module      Module    @relation(fields: [moduleId], references: [id])

  @@unique([branchId, moduleId])
  @@map("branch_modules")
}

model Department {
  id       String  @id @default(uuid())
  branchId String
  name     String
  type     String  @default("clinical")
  isActive Boolean @default(true)
  branch   Branch  @relation(fields: [branchId], references: [id])

  @@map("departments")
}

model User {
  id                     String          @id @default(uuid())
  tenantId               String
  branchId               String
  username               String          @unique
  email                  String          @unique
  passwordHash           String
  name                   String
  roleIds                String[]
  departmentIds          String[]
  biometricTemplate      String?
  isActive               Boolean         @default(true)
  lastLoginAt            DateTime?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  admissions        Admission[]     @relation("AdmittingDoctor")
  attendanceLogs    AttendanceLog[]
  performedAuditLog AuditLog[]      @relation("PerformedBy")
  createdAuditLogs  AuditLog[]      @relation("CreatedBy")
  appointments      Appointment[]   @relation("DoctorAppointments")
  encounters        Encounter[]
  opdNotes          OPDNote[]
  prescriptions     Prescription[]
  branch            Branch          @relation(fields: [branchId], references: [id])
  tenant            Tenant          @relation(fields: [tenantId], references: [id])

  @@map("users")
}

model Patient {
  id                String             @id @default(uuid())
  tenantId          String
  branchId          String
  mrn               String
  name              String
  dob               DateTime?
  gender            String?
  contact           String?
  email             String?
  address           String?
  photo             String?
  biometricTemplate String?
  emergencyContact  String?
  bloodGroup        String?
  allergies         String?
  referralSourceId  String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  admissions        Admission[]
  appointments      Appointment[]
  dietOrders        DietOrder[]
  encounters        Encounter[]
  feedbacks         Feedback[]
  incidents         Incident[]
  invoices          Invoice[]
  opdNotes          OPDNote[]
  orders            Order[]
  branch            Branch             @relation(fields: [branchId], references: [id])
  tenant            Tenant             @relation(fields: [tenantId], references: [id])
  preAuths          PreAuthorization[]
  referralSource    ReferralSource?    @relation(fields: [referralSourceId], references: [id])
  commissions       Commission[]
  insurances        PatientInsurance[]
  documents         Document[]
  criticalAlerts    CriticalAlert[]
  radiologyStudies  RadiologyStudy[]
  bedReservations   BedReservation[]
  nursingCarePlans  NursingCarePlan[]

  @@unique([tenantId, mrn])
  @@index([tenantId, name])
  @@index([tenantId, contact])
  @@index([tenantId, email])
  @@index([tenantId, dob])
  @@map("patients")
}

model Appointment {
  id              String      @id @default(uuid())
  tenantId        String
  branchId        String?
  patientId       String
  doctorId        String?     // Optional - not needed for lab/radiology
  appointmentDate DateTime
  appointmentTime String
  endTime         String?     // For appointments with duration
  type            String      @default("consultation") // consultation, lab, radiology, procedure, health_checkup
  category        String?     // sub-category: blood_test, urine_test, xray, ct_scan, mri, ultrasound, ecg, etc.
  status          String      @default("scheduled") // scheduled, confirmed, in_progress, completed, cancelled, no_show
  priority        String      @default("normal") // normal, urgent, emergency
  reason          String?
  notes           String?
  department      String?
  // Lab/Radiology specific
  testIds         String[]    // Array of test IDs (lab tests, radiology tests)
  testNames       String[]    // Array of test names for display
  modality        String?     // For radiology: X-Ray, CT, MRI, Ultrasound, etc.
  preparationInstructions String? // Fasting, etc.
  // Scheduling
  estimatedDuration Int?      // In minutes
  roomNumber      String?
  machineId       String?     // For equipment-based tests
  technicianId    String?     // Lab technician or radiographer
  // Referral
  referredBy      String?     // Doctor who referred
  referralNotes   String?
  // Results
  reportReady     Boolean     @default(false)
  reportUrl       String?
  // Billing
  invoiceId       String?
  isPaid          Boolean     @default(false)
  // Metadata
  createdBy       String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  patient         Patient     @relation(fields: [patientId], references: [id])
  doctor          User?       @relation("DoctorAppointments", fields: [doctorId], references: [id])
  encounters      Encounter[]

  @@index([patientId])
  @@index([doctorId])
  @@index([appointmentDate])
  @@index([status])
  @@index([type])
  @@index([tenantId, branchId, appointmentDate])
  @@map("appointments")
}

model Encounter {
  id             String      @id @default(uuid())
  patientId      String
  branchId       String
  type           String
  visitDate      DateTime    @default(now())
  doctorId       String?
  status         String      @default("active")
  chiefComplaint String?
  appointmentId  String?
  tokenNumber    String?
  startTime      DateTime?
  endTime        DateTime?
  subjective     String?
  objective      String?
  assessment     String?
  plan           String?
  vitals         Json?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt
  admission      Admission?
  appointment    Appointment? @relation(fields: [appointmentId], references: [id])
  branch         Branch      @relation(fields: [branchId], references: [id])
  doctor         User?       @relation(fields: [doctorId], references: [id])
  patient        Patient     @relation(fields: [patientId], references: [id])
  invoices       Invoice[]
  opdNotes       OPDNote[]
  orders         Order[]

  @@index([appointmentId])
  @@index([status])
  @@index([tokenNumber])
  @@map("encounters")
}

model Admission {
  id                   String    @id @default(uuid())
  encounterId          String    @unique
  patientId            String
  admissionDate        DateTime  @default(now())
  dischargeDate        DateTime?
  bedId                String?
  admittingDoctorId    String?
  status               String    @default("active")
  diagnosis            String?
  patientInsuranceId   String?
  preAuthorizationId   String?
  insuranceVerified    Boolean   @default(false)
  insuranceVerifiedAt  DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  admittingDoctor      User?       @relation("AdmittingDoctor", fields: [admittingDoctorId], references: [id])
  bed                  Bed?        @relation(fields: [bedId], references: [id])
  encounter            Encounter   @relation(fields: [encounterId], references: [id])
  patient              Patient     @relation(fields: [patientId], references: [id])
  ipdNotes             IPDNote[]
  ipdCharges           IPDCharge[]
  nursingCarePlans     NursingCarePlan[]

  @@map("admissions")
}

model Bed {
  id           String           @id @default(uuid())
  branchId     String
  wardId       String?
  bedNumber    String
  category     String           @default("general")
  status       String           @default("vacant")
  floor        String?
  dailyRate    Decimal?         @db.Decimal(10, 2)
  admissions   Admission[]
  reservations BedReservation[]
  branch       Branch           @relation(fields: [branchId], references: [id])
  ward         Ward?            @relation(fields: [wardId], references: [id])

  @@unique([branchId, bedNumber])
  @@index([wardId])
  @@map("beds")
}

model OPDNote {
  id             String         @id @default(uuid())
  encounterId    String
  patientId      String
  doctorId       String
  chiefComplaint String?
  history        String?
  vitals         Json?
  examination    String?
  assessment     String?
  plan           String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  doctor         User           @relation(fields: [doctorId], references: [id])
  encounter      Encounter      @relation(fields: [encounterId], references: [id])
  patient        Patient        @relation(fields: [patientId], references: [id])
  prescriptions  Prescription[]

  @@map("opd_notes")
}

model Prescription {
  id         String   @id @default(uuid())
  opdNoteId  String?
  admissionId String?
  patientId  String
  doctorId   String
  drugs      Json     // Array of {drugId, drugName, dosage, frequency, duration, quantity, instructions}
  status     String   @default("pending") // pending, partial, dispensed
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  doctor     User     @relation(fields: [doctorId], references: [id])
  opdNote    OPDNote? @relation(fields: [opdNoteId], references: [id])

  @@index([patientId])
  @@index([status])
  @@map("prescriptions")
}

model IPDNote {
  id          String    @id @default(uuid())
  admissionId String
  noteType    String
  note        String
  authorId    String?
  createdAt   DateTime  @default(now())
  admission   Admission @relation(fields: [admissionId], references: [id])

  @@index([admissionId])
  @@index([noteType])
  @@map("ipd_notes")
}

model Order {
  id            String     @id @default(uuid())
  patientId     String
  encounterId   String?
  admissionId   String?
  orderType     String
  orderedBy     String
  orderedAt     DateTime   @default(now())
  status        String     @default("pending")
  details       Json
  priority      String     @default("routine")
  billingStatus String     @default("unbilled") // unbilled, billed, paid
  invoiceId     String?
  chargeAmount  Decimal?   @db.Decimal(10, 2)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  encounter        Encounter?       @relation(fields: [encounterId], references: [id])
  patient          Patient          @relation(fields: [patientId], references: [id])
  results          Result[]
  radiologyStudies RadiologyStudy[]

  @@index([patientId])
  @@index([admissionId])
  @@index([orderType, status])
  @@index([billingStatus])
  @@index([invoiceId])
  @@index([orderedAt])
  @@map("orders")
}

model Result {
  id         String   @id @default(uuid())
  orderId    String
  resultData Json
  resultedAt DateTime @default(now())
  verifiedBy String?
  isCritical Boolean  @default(false)
  createdAt  DateTime @default(now())
  order      Order    @relation(fields: [orderId], references: [id])

  @@map("results")
}

model CriticalAlert {
  id               String   @id @default(uuid())
  orderId          String
  resultId         String?
  patientId        String
  testName         String
  value            String
  unit             String?
  normalRange      String?
  alertedAt        DateTime @default(now())
  acknowledgedAt   DateTime?
  acknowledgedBy   String?
  status           String   @default("unacknowledged") // unacknowledged, acknowledged
  notifiedDoctorId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  patient          Patient  @relation(fields: [patientId], references: [id])

  @@map("critical_alerts")
}

model Invoice {
  id               String       @id @default(uuid())
  patientId        String
  encounterId      String?
  type             String
  items            Json
  subtotal         Decimal      @db.Decimal(10, 2)
  discount         Decimal      @default(0) @db.Decimal(10, 2)
  tax              Decimal      @default(0) @db.Decimal(10, 2)
  total            Decimal      @db.Decimal(10, 2)
  paid             Decimal      @default(0) @db.Decimal(10, 2)
  balance          Decimal      @db.Decimal(10, 2)
  status           String       @default("draft")
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  encounter        Encounter?   @relation(fields: [encounterId], references: [id])
  patient          Patient      @relation(fields: [patientId], references: [id])
  payments         Payment[]
  commissions      Commission[]
  journalEntries   JournalEntry[]
  doctorRevenues   DoctorRevenue[]

  @@index([patientId])
  @@index([status])
  @@index([createdAt])
  @@map("invoices")
}

model Payment {
  id                 String   @id @default(uuid())
  invoiceId          String
  amount             Decimal  @db.Decimal(10, 2)
  mode               String   // cash, card, upi, netbanking, razorpay, etc.
  transactionRef     String?
  paidAt             DateTime @default(now())
  receivedBy         String?
  createdAt          DateTime @default(now())
  invoice            Invoice  @relation(fields: [invoiceId], references: [id])

  // Razorpay specific fields
  razorpayOrderId    String?  @unique
  razorpayPaymentId  String?  @unique
  razorpaySignature  String?
  gatewayStatus      String?  // initiated, captured, failed, refunded
  gatewayResponse    Json?    // Full gateway response for debugging
  refundId           String?  // For refund tracking
  refundAmount       Decimal? @db.Decimal(10, 2)
  refundedAt         DateTime?

  @@index([invoiceId])
  @@index([paidAt])
  @@map("payments")
}

model AttendanceLog {
  id        String   @id @default(uuid())
  userId    String
  branchId  String
  deviceId  String?
  punchTime DateTime @default(now())
  punchType String
  location  String?
  createdAt DateTime @default(now())
  branch    Branch   @relation(fields: [branchId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("attendance_logs")
}

model Feedback {
  id         String   @id @default(uuid())
  patientId  String?
  type       String
  message    String
  resolution String?
  status     String   @default("pending")
  reportedBy String?
  resolvedBy String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  patient    Patient? @relation(fields: [patientId], references: [id])

  @@map("feedbacks")
}

model AuditLog {
  id              String   @id @default(uuid())
  userId          String?
  action          String
  resource        String
  resourceId      String?
  oldValue        Json?
  newValue        Json?
  ipAddress       String?
  userAgent       String?
  timestamp       DateTime @default(now())
  performedBy     String?
  performedByUser User?    @relation("PerformedBy", fields: [performedBy], references: [id])
  user            User?    @relation("CreatedBy", fields: [userId], references: [id])

  @@map("audit_logs")
}

model Drug {
  id            String          @id @default(uuid())
  name          String
  genericName   String
  form          String
  strength      String
  category      String
  isNarcotic    Boolean         @default(false)
  price         Decimal         @db.Decimal(10, 2)
  isActive      Boolean         @default(true)
  code          String?         @unique
  barcode       String?         @unique
  reorderLevel  Int             @default(10)
  stockQuantity Int             @default(0)
  stocks        PharmacyStock[]

  @@map("drugs")
}

model PharmacyStock {
  id            String   @id @default(uuid())
  drugId        String
  batchNumber   String
  expiryDate    DateTime
  quantity      Int
  purchasePrice Decimal  @db.Decimal(10, 2)
  mrp           Decimal  @db.Decimal(10, 2)
  supplierId    String?
  supplierName  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  drug          Drug     @relation(fields: [drugId], references: [id])

  @@map("pharmacy_stocks")
}

model PharmacySale {
  id             String              @id @default(uuid())
  invoiceNumber  String              @unique
  patientName    String?
  patientMRN     String?
  patientId      String?
  prescriptionId String?             // Link to prescription if dispensed from prescription
  total          Decimal             @db.Decimal(10, 2)
  paymentMode    String              @default("cash")
  items          PharmacySaleItem[]
  createdBy      String?
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt

  @@index([prescriptionId])
  @@map("pharmacy_sales")
}

model PharmacySaleItem {
  id          String        @id @default(uuid())
  saleId      String
  drugId      String
  drugName    String
  batchNumber String?
  quantity    Int
  unitPrice   Decimal       @db.Decimal(10, 2)
  total       Decimal       @db.Decimal(10, 2)
  sale        PharmacySale  @relation(fields: [saleId], references: [id], onDelete: Cascade)

  @@map("pharmacy_sale_items")
}

model LabTestMaster {
  id          String  @id @default(uuid())
  name        String
  code        String  @unique
  category    String
  price       Decimal @db.Decimal(10, 2)
  tat         Int
  unit        String?
  normalRange String?
  isActive    Boolean @default(true)

  @@map("lab_test_master")
}

model RadiologyTestMaster {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  modality String
  price    Decimal @db.Decimal(10, 2)
  tat      Int
  isActive Boolean @default(true)

  @@map("radiology_test_master")
}

model ProcedureMaster {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  category String
  price    Decimal @db.Decimal(10, 2)
  isActive Boolean @default(true)

  @@map("procedure_master")
}

model PackageMaster {
  id       String  @id @default(uuid())
  name     String
  code     String  @unique
  items    Json
  price    Decimal @db.Decimal(10, 2)
  isActive Boolean @default(true)

  @@map("package_master")
}

model Ward {
  id           String  @id @default(uuid())
  tenantId     String?
  branchId     String?
  name         String
  type         String
  floor        String?
  building     String?
  totalBeds    Int
  tariffPerDay Decimal @db.Decimal(10, 2)
  isActive     Boolean @default(true)
  beds         Bed[]

  @@index([tenantId])
  @@index([branchId])
  @@map("wards")
}

model OTTheatre {
  id        String  @id @default(uuid())
  name      String
  type      String
  floor     String?
  equipment Json?
  isActive  Boolean @default(true)

  @@map("ot_theatres")
}

model TPAMaster {
  id              String             @id @default(uuid())
  name            String
  type            String
  contactPerson   String?
  contact         String?
  email           String?
  address         String?
  creditLimit     Decimal?           @db.Decimal(12, 2)
  discountPercent Decimal?           @db.Decimal(5, 2)
  isActive          Boolean            @default(true)
  preAuths          PreAuthorization[]
  patientInsurances PatientInsurance[]

  @@map("tpa_master")
}

model PreAuthorization {
  id               String    @id @default(uuid())
  patientId        String
  tpaId            String
  requestDate      DateTime  @default(now())
  approvalDate     DateTime?
  status           String    @default("pending")
  requestedAmount  Decimal   @db.Decimal(10, 2)
  approvedAmount   Decimal?  @db.Decimal(10, 2)
  diagnosis        String?
  procedurePlanned String?
  remarks          String?
  approvalNumber   String?
  validTill        DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  patient          Patient   @relation(fields: [patientId], references: [id])
  tpa              TPAMaster @relation(fields: [tpaId], references: [id])

  @@map("pre_authorizations")
}

model PatientInsurance {
  id                        String                        @id @default(uuid())
  patientId                 String
  tpaId                     String
  policyNumber              String
  policyHolderName          String?
  validFrom                 DateTime
  validTill                 DateTime
  sumInsured                Decimal                       @db.Decimal(12, 2)
  usedAmount                Decimal                       @default(0) @db.Decimal(12, 2)
  isActive                  Boolean                       @default(true)
  createdAt                 DateTime                      @default(now())
  updatedAt                 DateTime                      @updatedAt
  patient                   Patient                       @relation(fields: [patientId], references: [id])
  tpa                       TPAMaster                     @relation(fields: [tpaId], references: [id])
  eligibilityChecks         InsuranceEligibilityCheck[]

  @@index([patientId])
  @@index([tpaId])
  @@index([policyNumber])
  @@map("patient_insurances")
}

model InventoryItem {
  id                 String              @id @default(uuid())
  name               String
  code               String              @unique
  barcode            String?             @unique
  category           String
  unit               String
  reorderLevel       Int                 @default(0)
  price              Decimal             @db.Decimal(10, 2)
  isActive           Boolean             @default(true)
  purchaseOrderItems PurchaseOrderItem[]
  stocks             Stock[]
  grnItems           GoodsReceiptItem[]
  transferItems      StockTransferItem[]

  @@map("inventory_items")
}

model Stock {
  id          String        @id @default(uuid())
  itemId      String
  storeId     String
  batchNumber String        @default("")
  expiryDate  DateTime?
  quantity    Int
  lastUpdated DateTime      @updatedAt
  item        InventoryItem @relation(fields: [itemId], references: [id])

  @@unique([itemId, storeId, batchNumber], name: "itemId_storeId_batchNumber")
  @@map("stocks")
}

model PurchaseOrder {
  id            String              @id @default(uuid())
  poNumber      String              @unique
  vendorName    String
  vendorContact String?
  orderDate     DateTime            @default(now())
  expectedDate  DateTime?
  status        String              @default("pending")
  totalAmount   Decimal             @db.Decimal(12, 2)
  remarks       String?
  createdBy     String?
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  items         PurchaseOrderItem[]

  @@map("purchase_orders")
}

model PurchaseOrderItem {
  id            String        @id @default(uuid())
  poId          String
  itemId        String
  quantity      Int
  rate          Decimal       @db.Decimal(10, 2)
  amount        Decimal       @db.Decimal(10, 2)
  item          InventoryItem @relation(fields: [itemId], references: [id])
  purchaseOrder PurchaseOrder @relation(fields: [poId], references: [id])

  @@map("purchase_order_items")
}

model GoodsReceipt {
  id              String              @id @default(uuid())
  grnNumber       String              @unique
  poId            String?             // Link to PO if applicable
  vendorName      String
  vendorInvoice   String?
  invoiceDate     DateTime?
  receivedDate    DateTime            @default(now())
  receivedBy      String?
  status          String              @default("draft") // draft, verified, posted
  totalAmount     Decimal             @db.Decimal(12, 2)
  remarks         String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  items           GoodsReceiptItem[]

  @@map("goods_receipts")
}

model GoodsReceiptItem {
  id              String        @id @default(uuid())
  grnId           String
  itemId          String
  quantityOrdered Int           @default(0)
  quantityReceived Int
  unitPrice       Decimal       @db.Decimal(10, 2)
  amount          Decimal       @db.Decimal(10, 2)
  batchNumber     String?
  expiryDate      DateTime?
  remarks         String?
  grn             GoodsReceipt  @relation(fields: [grnId], references: [id])
  item            InventoryItem @relation(fields: [itemId], references: [id])

  @@map("goods_receipt_items")
}

model StockTransfer {
  id              String              @id @default(uuid())
  transferNumber  String              @unique
  fromStoreId     String
  toStoreId       String
  transferDate    DateTime            @default(now())
  transferredBy   String?
  receivedBy      String?
  receivedAt      DateTime?
  status          String              @default("pending") // pending, in_transit, received, cancelled
  remarks         String?
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  items           StockTransferItem[]

  @@map("stock_transfers")
}

model StockTransferItem {
  id              String        @id @default(uuid())
  transferId      String
  itemId          String
  quantity        Int
  batchNumber     String?
  transfer        StockTransfer @relation(fields: [transferId], references: [id])
  item            InventoryItem @relation(fields: [itemId], references: [id])

  @@map("stock_transfer_items")
}

model HousekeepingTask {
  id          String    @id @default(uuid())
  bedId       String?
  taskType    String
  assignedTo  String?
  status      String    @default("pending")
  priority    String    @default("normal")
  scheduledAt DateTime?
  completedAt DateTime?
  remarks     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@map("housekeeping_tasks")
}

model DietOrder {
  id          String   @id @default(uuid())
  patientId   String
  admissionId String?
  dietType    String
  mealType    String
  orderDate   DateTime @default(now())
  status      String   @default("pending")
  remarks     String?
  patient     Patient  @relation(fields: [patientId], references: [id])

  @@map("diet_orders")
}

model Asset {
  id              String           @id @default(uuid())
  name            String
  assetCode       String           @unique
  category        String
  location        String?
  purchaseDate    DateTime?
  warrantyExpiry  DateTime?
  amcVendor       String?
  amcExpiry       DateTime?
  status          String           @default("active")
  isActive        Boolean          @default(true)
  maintenanceLogs MaintenanceLog[]

  @@map("assets")
}

model MaintenanceLog {
  id              String    @id @default(uuid())
  assetId         String
  maintenanceType String
  scheduledDate   DateTime?
  completedDate   DateTime?
  technician      String?
  findings        String?
  actionTaken     String?
  cost            Decimal?  @db.Decimal(10, 2)
  status          String    @default("scheduled")
  createdAt       DateTime  @default(now())
  asset           Asset     @relation(fields: [assetId], references: [id])

  @@map("maintenance_logs")
}

model AmbulanceTrip {
  id             String    @id @default(uuid())
  vehicleNumber  String
  driverName     String?
  driverContact  String?
  patientId      String?
  pickupLocation String
  dropLocation   String
  tripType       String
  startTime      DateTime  @default(now())
  endTime        DateTime?
  distance       Decimal?  @db.Decimal(6, 2)
  charges        Decimal?  @db.Decimal(10, 2)
  status         String    @default("in_progress")
  remarks        String?
  createdAt      DateTime  @default(now())

  @@map("ambulance_trips")
}

model Incident {
  id            String    @id @default(uuid())
  type          String
  severity      String
  patientId     String?
  location      String?
  description   String
  reportedBy    String?
  reportedAt    DateTime  @default(now())
  investigation String?
  rootCause     String?
  actionTaken   String?
  status        String    @default("reported")
  closedAt      DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  patient       Patient?  @relation(fields: [patientId], references: [id])

  @@map("incidents")
}

// ===========================
// BROKER/REFERRAL COMMISSION SYSTEM
// ===========================

model ReferralSource {
  id                 String              @id @default(uuid())
  tenantId           String
  code               String              @unique
  name               String
  type               String              // broker, agent, doctor, hospital, corporate, self
  contact            String?
  email              String?
  address            String?
  commissionType     String              @default("percentage") // percentage, fixed, tiered
  commissionValue    Decimal             @default(0) @db.Decimal(5, 2) // percentage or fixed amount
  commissionTiers    Json?               // for tiered commission: [{min: 0, max: 10000, value: 5}, {min: 10000, max: null, value: 10}]
  paymentTerms       String?             // payment terms description
  bankName           String?
  accountNumber      String?
  ifscCode           String?
  panNumber          String?
  gstNumber          String?
  isActive           Boolean             @default(true)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  patients           Patient[]
  commissions        Commission[]
  commissionPayouts  CommissionPayout[]

  @@map("referral_sources")
}

model Commission {
  id                  String             @id @default(uuid())
  referralSourceId    String
  patientId           String
  invoiceId           String
  invoiceAmount       Decimal            @db.Decimal(10, 2)
  commissionType      String             // percentage, fixed
  commissionRate      Decimal?           @db.Decimal(5, 2) // percentage rate if applicable
  commissionAmount    Decimal            @db.Decimal(10, 2)
  status              String             @default("pending") // pending, approved, paid, cancelled
  approvedBy          String?
  approvedAt          DateTime?
  paidAt              DateTime?
  payoutId            String?
  remarks             String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  referralSource      ReferralSource     @relation(fields: [referralSourceId], references: [id])
  patient             Patient            @relation(fields: [patientId], references: [id])
  invoice             Invoice            @relation(fields: [invoiceId], references: [id])
  payout              CommissionPayout?  @relation(fields: [payoutId], references: [id])

  @@index([referralSourceId])
  @@index([status])
  @@map("commissions")
}

model CommissionPayout {
  id                 String           @id @default(uuid())
  referralSourceId   String
  payoutNumber       String           @unique
  fromDate           DateTime
  toDate             DateTime
  totalAmount        Decimal          @db.Decimal(12, 2)
  paymentMode        String           // cash, cheque, bank_transfer, upi
  paymentReference   String?
  paymentDate        DateTime         @default(now())
  paidBy             String?
  remarks            String?
  status             String           @default("processed") // processed, cancelled
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  referralSource     ReferralSource   @relation(fields: [referralSourceId], references: [id])
  commissions        Commission[]

  @@map("commission_payouts")
}

// ===========================
// ACCOUNTS SYSTEM
// ===========================

model FiscalYear {
  id             String         @id @default(uuid())
  tenantId       String
  name           String         // FY 2024-25
  startDate      DateTime
  endDate        DateTime
  isActive       Boolean        @default(true)
  isClosed       Boolean        @default(false)
  createdAt      DateTime       @default(now())
  journalEntries JournalEntry[]

  @@unique([tenantId, name])
  @@map("fiscal_years")
}

model AccountGroup {
  id           String        @id @default(uuid())
  tenantId     String
  name         String
  code         String        @unique
  type         String        // asset, liability, income, expense, equity
  parentId     String?
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  parent       AccountGroup? @relation("GroupHierarchy", fields: [parentId], references: [id])
  children     AccountGroup[] @relation("GroupHierarchy")
  accountHeads AccountHead[]

  @@map("account_groups")
}

model AccountHead {
  id                  String              @id @default(uuid())
  tenantId            String
  groupId             String
  name                String
  code                String              @unique
  type                String              // asset, liability, income, expense, equity
  subType             String?             // current_asset, fixed_asset, current_liability, etc.
  openingBalance      Decimal             @default(0) @db.Decimal(12, 2)
  currentBalance      Decimal             @default(0) @db.Decimal(12, 2)
  isSystemAccount     Boolean             @default(false) // cannot be deleted
  isActive            Boolean             @default(true)
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  group               AccountGroup        @relation(fields: [groupId], references: [id])
  journalEntryLines   JournalEntryLine[]
  ledgerEntries       LedgerEntry[]

  @@map("account_heads")
}

model JournalEntry {
  id              String             @id @default(uuid())
  tenantId        String
  fiscalYearId    String
  entryNumber     String             @unique
  entryDate       DateTime           @default(now())
  entryType       String             // manual, automatic, opening, closing, adjustment
  referenceType   String?            // invoice, payment, salary, purchase, etc.
  referenceId     String?            // ID of the related entity
  description     String
  totalDebit      Decimal            @db.Decimal(12, 2)
  totalCredit     Decimal            @db.Decimal(12, 2)
  isPosted        Boolean            @default(false)
  postedAt        DateTime?
  postedBy        String?
  createdBy       String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  fiscalYear      FiscalYear         @relation(fields: [fiscalYearId], references: [id])
  invoice         Invoice?           @relation(fields: [referenceId], references: [id])
  lines           JournalEntryLine[]
  ledgerEntries   LedgerEntry[]

  @@index([referenceType, referenceId])
  @@map("journal_entries")
}

model JournalEntryLine {
  id              String        @id @default(uuid())
  journalEntryId  String
  accountHeadId   String
  description     String?
  debitAmount     Decimal       @default(0) @db.Decimal(12, 2)
  creditAmount    Decimal       @default(0) @db.Decimal(12, 2)
  createdAt       DateTime      @default(now())
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
  accountHead     AccountHead   @relation(fields: [accountHeadId], references: [id])

  @@map("journal_entry_lines")
}

model LedgerEntry {
  id              String        @id @default(uuid())
  tenantId        String
  accountHeadId   String
  journalEntryId  String
  entryDate       DateTime
  description     String
  debitAmount     Decimal       @default(0) @db.Decimal(12, 2)
  creditAmount    Decimal       @default(0) @db.Decimal(12, 2)
  runningBalance  Decimal       @db.Decimal(12, 2)
  createdAt       DateTime      @default(now())
  accountHead     AccountHead   @relation(fields: [accountHeadId], references: [id])
  journalEntry    JournalEntry  @relation(fields: [journalEntryId], references: [id])

  @@index([accountHeadId, entryDate])
  @@map("ledger_entries")
}

// ===========================
// DOCTOR REVENUE SHARING SYSTEM
// ===========================

model DoctorContract {
  id                    String          @id @default(uuid())
  doctorId              String          @unique
  contractNumber        String          @unique
  startDate             DateTime
  endDate               DateTime?
  revenueShareType      String          // percentage, fixed_per_consultation, tiered
  revenueShareValue     Decimal         @db.Decimal(5, 2) // percentage or fixed amount
  revenueTiers          Json?           // for tiered: [{min: 0, max: 100000, value: 30}, {min: 100000, max: null, value: 40}]
  consultationFeeShare  Decimal?        @db.Decimal(5, 2) // percentage share of consultation fees
  procedureFeeShare     Decimal?        @db.Decimal(5, 2) // percentage share of procedure fees
  paymentCycle          String          @default("monthly") // daily, weekly, monthly, quarterly
  bankName              String?
  accountNumber         String?
  ifscCode              String?
  panNumber             String?
  isActive              Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  doctorRevenues        DoctorRevenue[]
  doctorPayouts         DoctorPayout[]

  @@map("doctor_contracts")
}

model DoctorRevenue {
  id                  String           @id @default(uuid())
  contractId          String
  doctorId            String
  invoiceId           String
  patientId           String
  revenueType         String           // consultation, procedure, investigation
  revenueAmount       Decimal          @db.Decimal(10, 2)
  shareType           String           // percentage, fixed
  shareRate           Decimal?         @db.Decimal(5, 2)
  shareAmount         Decimal          @db.Decimal(10, 2)
  status              String           @default("pending") // pending, approved, paid
  approvedBy          String?
  approvedAt          DateTime?
  paidAt              DateTime?
  payoutId            String?
  remarks             String?
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  contract            DoctorContract   @relation(fields: [contractId], references: [id])
  invoice             Invoice          @relation(fields: [invoiceId], references: [id])
  payout              DoctorPayout?    @relation(fields: [payoutId], references: [id])

  @@index([doctorId])
  @@index([status])
  @@map("doctor_revenues")
}

model DoctorPayout {
  id              String          @id @default(uuid())
  contractId      String
  doctorId        String
  payoutNumber    String          @unique
  fromDate        DateTime
  toDate          DateTime
  totalRevenue    Decimal         @db.Decimal(12, 2)
  totalShare      Decimal         @db.Decimal(12, 2)
  deductions      Decimal         @default(0) @db.Decimal(12, 2)
  netAmount       Decimal         @db.Decimal(12, 2)
  paymentMode     String          // cash, cheque, bank_transfer, upi
  paymentReference String?
  paymentDate     DateTime        @default(now())
  paidBy          String?
  remarks         String?
  status          String          @default("processed") // processed, cancelled
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  contract        DoctorContract  @relation(fields: [contractId], references: [id])
  revenues        DoctorRevenue[]

  @@map("doctor_payouts")
}

// ===========================
// BLOOD BANK SYSTEM
// ===========================

model BloodDonor {
  id              String           @id @default(uuid())
  donorId         String           @unique
  name            String
  age             Int
  gender          String
  bloodType       String
  phone           String
  email           String?
  address         String?
  lastDonationAt  DateTime?
  totalDonations  Int              @default(0)
  isEligible      Boolean          @default(true)
  screeningStatus String           @default("pending") // pending, cleared, rejected
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  donations       BloodDonation[]

  @@map("blood_donors")
}

model BloodDonation {
  id              String         @id @default(uuid())
  donorId         String
  donationDate    DateTime       @default(now())
  bloodType       String
  component       String         @default("whole_blood")
  volume          Int            @default(450) // ml
  bagNumber       String         @unique
  collectedBy     String?
  status          String         @default("collected") // collected, processed, available, expired, discarded
  expiryDate      DateTime
  createdAt       DateTime       @default(now())
  donor           BloodDonor     @relation(fields: [donorId], references: [id])
  inventory       BloodInventory?

  @@map("blood_donations")
}

model BloodInventory {
  id              String          @id @default(uuid())
  donationId      String?         @unique
  bloodType       String
  component       String
  bagNumber       String          @unique
  volume          Int
  collectionDate  DateTime
  expiryDate      DateTime
  status          String          @default("available") // available, reserved, issued, expired, discarded
  location        String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  donation        BloodDonation?  @relation(fields: [donationId], references: [id])
  issuances       BloodIssuance[]

  @@index([bloodType, component, status])
  @@map("blood_inventory")
}

model BloodRequest {
  id                String          @id @default(uuid())
  patientId         String?
  patientName       String
  patientMRN        String?
  bloodType         String
  component         String
  unitsRequested    Int
  urgency           String          @default("routine") // routine, urgent, emergency
  indication        String?
  requestedBy       String?
  requestedAt       DateTime        @default(now())
  crossMatchedAt    DateTime?
  crossMatchedBy    String?
  crossMatchResult  String?         // compatible, incompatible
  status            String          @default("pending") // pending, crossmatched, approved, issued, cancelled
  remarks           String?
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  issuances         BloodIssuance[]

  @@map("blood_requests")
}

model BloodIssuance {
  id              String          @id @default(uuid())
  requestId       String
  inventoryId     String
  issuedAt        DateTime        @default(now())
  issuedBy        String?
  receivedBy      String?
  status          String          @default("issued") // issued, returned, transfused
  remarks         String?
  createdAt       DateTime        @default(now())
  request         BloodRequest    @relation(fields: [requestId], references: [id])
  inventory       BloodInventory  @relation(fields: [inventoryId], references: [id])

  @@map("blood_issuances")
}

// ===========================
// HR & EMPLOYEE MANAGEMENT
// ===========================

model Employee {
  id              String    @id @default(uuid())
  employeeId      String    @unique
  name            String
  email           String?
  phone           String?
  department      String?
  designation     String?
  joiningDate     DateTime?
  salary          Decimal?  @db.Decimal(12, 2)
  status          String    @default("active") // active, on_leave, terminated
  shift           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  leaves          LeaveRequest[]
  attendances     EmployeeAttendance[]
  shifts          Shift[]

  @@map("employees")
}

model EmployeeAttendance {
  id          String    @id @default(uuid())
  employeeId  String
  date        DateTime  @db.Date
  checkIn     DateTime?
  checkOut    DateTime?
  status      String    @default("present") // present, absent, half_day, on_leave
  remarks     String?
  createdAt   DateTime  @default(now())
  employee    Employee  @relation(fields: [employeeId], references: [id])

  @@unique([employeeId, date])
  @@map("employee_attendances")
}

model LeaveRequest {
  id          String    @id @default(uuid())
  employeeId  String
  leaveType   String    // sick, casual, earned, maternity, etc.
  fromDate    DateTime
  toDate      DateTime
  reason      String?
  status      String    @default("pending") // pending, approved, rejected
  approvedBy  String?
  approvedAt  DateTime?
  remarks     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  employee    Employee  @relation(fields: [employeeId], references: [id])

  @@map("leave_requests")
}

model Payroll {
  id              String    @id @default(uuid())
  employeeId      String
  month           Int       // 1-12
  year            Int
  basicSalary     Decimal   @db.Decimal(12, 2)
  allowances      Decimal   @default(0) @db.Decimal(12, 2)
  deductions      Decimal   @default(0) @db.Decimal(12, 2)
  overtime        Decimal   @default(0) @db.Decimal(12, 2)
  netSalary       Decimal   @db.Decimal(12, 2)
  workingDays     Int       @default(0)
  presentDays     Int       @default(0)
  leaveDays       Int       @default(0)
  status          String    @default("draft") // draft, processed, paid
  processedBy     String?
  processedAt     DateTime?
  paidAt          DateTime?
  remarks         String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([employeeId, month, year])
  @@map("payroll")
}

// ===========================
// AMBULANCE MANAGEMENT
// ===========================

model AmbulanceVehicle {
  id              String    @id @default(uuid())
  vehicleNumber   String    @unique
  type            String    // ALS, BLS, patient_transport
  driverName      String?
  driverPhone     String?
  status          String    @default("available") // available, on_trip, maintenance, out_of_service
  lastMaintenance DateTime?
  currentLocation String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("ambulance_vehicles")
}

// ===========================
// EMERGENCY CASE TRACKING
// ===========================

model EmergencyCase {
  id              String    @id @default(uuid())
  patientId       String?
  patientName     String
  patientAge      Int?
  patientGender   String?
  patientContact  String?
  arrivalTime     DateTime  @default(now())
  triageCategory  String    // RED, YELLOW, GREEN
  chiefComplaint  String?
  vitalSigns      Json?
  isMLC           Boolean   @default(false)
  mlcNumber       String?
  assignedDoctor  String?
  status          String    @default("active") // active, admitted, discharged, transferred
  disposition     String?   // admitted_ipd, admitted_icu, discharged, transferred, dama, expired
  dischargeTime   DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("emergency_cases")
}

// ===========================
// ICU MANAGEMENT
// ===========================

model ICUBed {
  id              String        @id @default(uuid())
  bedNumber       String        @unique
  icuUnit         String        // MICU, SICU, NICU, PICU, CCU
  status          String        @default("vacant") // vacant, occupied, maintenance
  currentPatient  String?
  admissionId     String?
  ventilatorId    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  vitalsRecords   ICUVitals[]

  @@map("icu_beds")
}

model ICUVitals {
  id              String    @id @default(uuid())
  icuBedId        String
  patientId       String?
  heartRate       Int?
  systolicBP      Int?
  diastolicBP     Int?
  temperature     Decimal?  @db.Decimal(4, 1)
  spo2            Int?
  respiratoryRate Int?
  gcs             Int?
  ventilatorMode  String?
  fio2            Int?
  peep            Int?
  recordedAt      DateTime  @default(now())
  recordedBy      String?
  icuBed          ICUBed    @relation(fields: [icuBedId], references: [id])

  @@map("icu_vitals")
}

// ===========================
// SURGERY/OT MANAGEMENT
// ===========================

model Surgery {
  id                    String                 @id @default(uuid())
  patientId             String?
  patientName           String
  patientMRN            String?
  procedureName         String
  surgeonId             String?
  surgeonName           String
  anesthetistId         String?
  anesthetistName       String?
  otRoomId              String?
  otRoom                String?
  scheduledDate         DateTime
  scheduledTime         String?
  estimatedDuration     Int?                   // minutes
  actualStartTime       DateTime?
  actualEndTime         DateTime?
  anesthesiaType        String?
  priority              String                 @default("elective") // emergency, urgent, elective
  status                String                 @default("scheduled") // scheduled, in_progress, completed, cancelled, postponed
  preOpChecklist        Boolean                @default(false)
  preOpChecklistDetails Json?                  // detailed pre-op checklist items
  postOpNotes           String?
  complications         String?
  implants              Json?
  consumables           Json?
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  anesthesiaRecord      AnesthesiaRecord?
  surgeryComplications  SurgeryComplication[]
  surgeryImplants       SurgeryImplant[]

  @@map("surgeries")
}

model AnesthesiaRecord {
  id                String   @id @default(uuid())
  surgeryId         String   @unique
  patientId         String
  anesthetistId     String
  preOpAssessment   Json     // ASA grade, airway assessment, NPO status, pre-existing conditions
  anesthesiaType    String   // general, spinal, epidural, local, regional, MAC
  agents            Json[]   // drugs used with dosages [{name, dose, route, time}]
  vitalsLog         Json[]   // periodic vitals during surgery [{time, hr, bp, spo2, temp, etco2}]
  airwayManagement  Json     // intubation details, tube size, cuff pressure, ventilator settings
  fluidBalance      Json     // IV fluids, blood products, urine output, drains
  complications     Json[]   // any complications during procedure [{time, type, description, management}]
  recoveryNotes     String?
  postOpInstructions String?
  startTime         DateTime
  endTime           DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  surgery           Surgery  @relation(fields: [surgeryId], references: [id])

  @@map("anesthesia_records")
}

model SurgeryComplication {
  id              String   @id @default(uuid())
  surgeryId       String
  type            String   // intraoperative, postoperative
  description     String
  severity        String   // minor, moderate, major, critical
  managementDone  String
  outcome         String
  reportedBy      String
  reportedAt      DateTime @default(now())
  createdAt       DateTime @default(now())
  surgery         Surgery  @relation(fields: [surgeryId], references: [id])

  @@map("surgery_complications")
}

model SurgeryImplant {
  id            String    @id @default(uuid())
  surgeryId     String
  implantName   String
  manufacturer  String
  serialNumber  String
  batchNumber   String
  expiryDate    DateTime?
  quantity      Int
  cost          Decimal   @db.Decimal(10, 2)
  createdAt     DateTime  @default(now())
  surgery       Surgery   @relation(fields: [surgeryId], references: [id])

  @@map("surgery_implants")
}

model OTRoom {
  id              String    @id @default(uuid())
  name            String    @unique
  type            String    // general, cardiac, neuro, orthopedic, etc.
  floor           String?
  status          String    @default("available") // available, in_use, cleaning, maintenance
  currentSurgery  String?
  equipment       Json?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("ot_rooms")
}

model Document {
  id            String    @id @default(uuid())
  tenantId      String
  patientId     String
  filename      String
  originalName  String
  mimeType      String
  size          Int
  category      String    // id_proof, insurance, medical_records, lab_reports, radiology, prescription, consent_form, discharge_summary, referral_letter, other
  description   String?
  path          String
  uploadedBy    String
  uploadedAt    DateTime  @default(now())
  isDeleted     Boolean   @default(false)
  patient       Patient   @relation(fields: [patientId], references: [id])

  @@map("documents")
}

model Notification {
  id            String    @id @default(uuid())
  tenantId      String
  type          String    // APPOINTMENT_REMINDER, APPOINTMENT_CONFIRMATION, LAB_RESULT, etc.
  message       String
  userId        String?   // Optional: the user this notification is for
  referenceId   String?   // The ID of the related entity (appointment, order, etc.)
  referenceType String?   // appointment, order, patient, etc.
  channel       String?   // sms, email, both, push
  status        String    @default("pending") // pending, sent, failed, delivered
  sentAt        DateTime?
  createdAt     DateTime  @default(now())

  @@index([tenantId, type])
  @@index([referenceId])
  @@map("notifications")
}

// ===========================
// INSURANCE CLAIMS & SETTLEMENTS
// ===========================

model Claim {
  id                    String       @id @default(uuid())
  tenantId              String
  claimNumber           String       @unique
  patientId             String
  patientInsuranceId    String?
  insuranceCompanyId    String?      // Reference to TPAMaster
  invoiceId             String?      // Link to invoice if claim is from invoice
  admissionId           String?
  claimType             String       // cashless, reimbursement
  claimAmount           Decimal      @db.Decimal(12, 2)
  approvedAmount        Decimal      @default(0) @db.Decimal(12, 2)
  rejectedAmount        Decimal      @default(0) @db.Decimal(12, 2)
  status                String       @default("submitted") // submitted, under_review, approved, rejected, settled
  submittedDate         DateTime     @default(now())
  approvedDate          DateTime?
  rejectedDate          DateTime?
  settledDate           DateTime?
  documents             Json?        // Array of document URLs/paths
  remarks               String?
  rejectionReason       String?
  createdBy             String?
  updatedBy             String?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  settlements           Settlement[]

  @@index([tenantId])
  @@index([patientId])
  @@index([status])
  @@index([claimNumber])
  @@map("claims")
}

model Settlement {
  id                String   @id @default(uuid())
  tenantId          String
  settlementNumber  String   @unique
  claimId           String
  claim             Claim    @relation(fields: [claimId], references: [id])
  settlementAmount  Decimal  @db.Decimal(12, 2)
  settlementDate    DateTime @default(now())
  paymentMode       String   // cheque, neft, rtgs, upi, cash
  transactionRef    String?  // Cheque number, transaction ID, etc.
  remarks           String?
  settledBy         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([tenantId])
  @@index([claimId])
  @@map("settlements")
}

// ===========================
// NURSING MODULE
// ===========================

model DutyRoster {
  id          String    @id @default(uuid())
  tenantId    String
  branchId    String
  nurseId     String
  nurseName   String
  date        DateTime  @db.Date
  shift       String    // morning, evening, night
  ward        String?
  department  String?
  status      String    @default("assigned") // assigned, completed, cancelled
  notes       String?
  createdBy   String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([nurseId, date, shift])
  @@index([branchId, date])
  @@index([nurseId])
  @@map("duty_rosters")
}

model MedicationAdministration {
  id                String    @id @default(uuid())
  tenantId          String
  branchId          String
  patientId         String
  admissionId       String?
  medicationName    String
  dosage            String
  route             String    // oral, IV, IM, subcutaneous, etc.
  frequency         String
  scheduledTime     DateTime
  administeredTime  DateTime?
  administeredBy    String?   // Nurse ID
  administeredByName String?
  status            String    @default("pending") // pending, administered, missed, refused
  notes             String?
  sideEffects       String?
  createdBy         String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([patientId, status])
  @@index([admissionId])
  @@index([scheduledTime])
  @@map("medication_administrations")
}

model HandoverNote {
  id           String    @id @default(uuid())
  tenantId     String
  branchId     String
  shift        String    // morning, evening, night
  date         DateTime  @db.Date
  ward         String?
  department   String?
  handoverFrom String?   // Nurse ID who is handing over
  handoverTo   String?   // Nurse ID who is receiving
  patientId    String?
  patientName  String?
  admissionId  String?
  notes        String
  priority     String    @default("normal") // normal, high, critical
  status       String    @default("active") // active, acknowledged, archived
  createdBy    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([branchId, date, shift])
  @@index([patientId])
  @@map("handover_notes")
}

model NursingVitals {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  patientId       String
  admissionId     String?
  heartRate       Int?
  systolicBP      Int?
  diastolicBP     Int?
  temperature     Decimal?  @db.Decimal(4, 1)
  spo2            Int?
  respiratoryRate Int?
  weight          Decimal?  @db.Decimal(5, 2)
  height          Decimal?  @db.Decimal(5, 2)
  bmi             Decimal?  @db.Decimal(4, 2)
  painScore       Int?      // 0-10 pain scale
  consciousness   String?   // alert, drowsy, unconscious
  notes           String?
  recordedAt      DateTime  @default(now())
  recordedBy      String?   // Nurse ID
  recordedByName  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([patientId, recordedAt])
  @@index([admissionId])
  @@map("nursing_vitals")
}

// ===========================
// NURSING CARE PLANS
// ===========================

model NursingCarePlan {
  id            String               @id @default(uuid())
  admissionId   String
  patientId     String
  createdBy     String
  status        String               @default("active")
  startDate     DateTime             @default(now())
  endDate       DateTime?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  admission     Admission            @relation(fields: [admissionId], references: [id])
  patient       Patient              @relation(fields: [patientId], references: [id])
  diagnoses     NursingDiagnosis[]
  interventions NursingIntervention[]
  evaluations   NursingEvaluation[]

  @@index([admissionId])
  @@index([patientId])
  @@map("nursing_care_plans")
}

model NursingDiagnosis {
  id          String          @id @default(uuid())
  carePlanId  String
  code        String?
  diagnosis   String
  relatedTo   String
  evidencedBy String[]
  priority    Int             @default(1)
  status      String          @default("active")
  createdAt   DateTime        @default(now())
  carePlan    NursingCarePlan @relation(fields: [carePlanId], references: [id])
  goals       NursingGoal[]

  @@map("nursing_diagnoses")
}

model NursingGoal {
  id          String           @id @default(uuid())
  diagnosisId String
  description String
  targetDate  DateTime
  outcome     String?
  evaluatedAt DateTime?
  createdAt   DateTime         @default(now())
  diagnosis   NursingDiagnosis @relation(fields: [diagnosisId], references: [id])

  @@map("nursing_goals")
}

model NursingIntervention {
  id           String                  @id @default(uuid())
  carePlanId   String
  category     String
  intervention String
  frequency    String
  instructions String?
  isActive     Boolean                 @default(true)
  createdAt    DateTime                @default(now())
  carePlan     NursingCarePlan         @relation(fields: [carePlanId], references: [id])
  executions   InterventionExecution[]

  @@map("nursing_interventions")
}

model InterventionExecution {
  id              String              @id @default(uuid())
  interventionId  String
  executedBy      String
  executedAt      DateTime            @default(now())
  notes           String?
  patientResponse String?
  intervention    NursingIntervention @relation(fields: [interventionId], references: [id])

  @@map("intervention_executions")
}

model NursingEvaluation {
  id            String          @id @default(uuid())
  carePlanId    String
  evaluatedBy   String
  evaluatedAt   DateTime        @default(now())
  overallStatus String
  notes         String
  modifications String?
  carePlan      NursingCarePlan @relation(fields: [carePlanId], references: [id])

  @@map("nursing_evaluations")
}

model NursingAssessmentScale {
  id          String   @id @default(uuid())
  admissionId String
  patientId   String
  scaleType   String
  score       Int
  riskLevel   String
  details     Json
  assessedBy  String
  assessedAt  DateTime @default(now())

  @@index([admissionId])
  @@map("nursing_assessment_scales")
}

// ===========================
// IPD CHARGE CAPTURE SYSTEM
// ===========================

model IPDCharge {
  id            String   @id @default(uuid())
  tenantId      String
  admissionId   String
  category      String   // bed, nursing, procedure, lab, radiology, pharmacy, consumable, consultation, other
  description   String
  quantity      Int      @default(1)
  unitPrice     Decimal  @db.Decimal(10, 2)
  amount        Decimal  @db.Decimal(10, 2)
  chargeDate    DateTime @default(now())
  orderId       String?  // Link to Order if charge is from an order
  capturedBy    String?  // User who captured/added this charge
  isAutomatic   Boolean  @default(false) // true if auto-captured, false if manually added
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  admission     Admission @relation(fields: [admissionId], references: [id])

  @@index([admissionId])
  @@index([category])
  @@index([chargeDate])
  @@map("ipd_charges")
}

// ===========================
// INSURANCE ELIGIBILITY VERIFICATION SYSTEM
// ===========================

model InsuranceEligibilityCheck {
  id                   String            @id @default(uuid())
  tenantId             String
  patientInsuranceId   String
  checkedAt            DateTime          @default(now())
  checkedBy            String?           // User ID who triggered the check
  status               String            // eligible, not_eligible, expired, not_started, limit_exceeded, pending_verification
  coverageDetails      Json?             // Detailed coverage information from TPA/verification system
  sumInsured           Decimal           @db.Decimal(12, 2) // Sum insured at the time of check
  usedAmount           Decimal           @db.Decimal(12, 2) // Amount utilized at the time of check
  remainingAmount      Decimal           @db.Decimal(12, 2) // Available coverage
  verificationSource   String            @default("manual") // manual, api, cached
  verificationResponse Json?             // Raw response from external verification API
  expiresAt            DateTime?         // When this eligibility check expires (for caching)
  remarks              String?
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  patientInsurance     PatientInsurance  @relation(fields: [patientInsuranceId], references: [id])

  @@index([patientInsuranceId])
  @@index([checkedAt])
  @@index([status])
  @@map("insurance_eligibility_checks")
}

// ===========================
// BARCODE SYSTEM
// ===========================

model Barcode {
  id          String   @id @default(uuid())
  code        String   @unique
  type        String   // EAN13, CODE128, QR, etc.
  entityType  String   // drug, inventory_item, patient, sample
  entityId    String
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@index([code])
  @@index([entityType, entityId])
  @@map("barcodes")
}

model BarcodeScan {
  id          String   @id @default(uuid())
  code        String
  scannedBy   String
  scannedAt   DateTime @default(now())
  location    String?  // pharmacy, lab, ward, etc.
  action      String   // lookup, dispense, receive, verify
  result      Json?    // scan result/entity found

  @@index([scannedAt])
  @@index([scannedBy])
  @@index([action])
  @@map("barcode_scans")
}

// ===========================
// SHIFT MANAGEMENT SYSTEM
// ===========================

model ShiftTemplate {
  id          String   @id @default(uuid())
  name        String   // Morning, Evening, Night, etc.
  code        String   @unique
  startTime   String   // "08:00"
  endTime     String   // "16:00"
  breakMinutes Int     @default(30)
  isOvernight Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  shifts      Shift[]

  @@map("shift_templates")
}

model Shift {
  id              String        @id @default(uuid())
  templateId      String
  employeeId      String
  date            DateTime      @db.Date
  actualStartTime DateTime?
  actualEndTime   DateTime?
  status          String        @default("scheduled") // scheduled, started, completed, absent, leave
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  template        ShiftTemplate @relation(fields: [templateId], references: [id])
  employee        Employee      @relation(fields: [employeeId], references: [id])
  swapRequests    ShiftSwapRequest[]

  @@unique([employeeId, date])
  @@index([date])
  @@index([status])
  @@map("shifts")
}

model ShiftSwapRequest {
  id              String   @id @default(uuid())
  requesterId     String
  requestedShiftId String
  offeredShiftId  String?
  targetEmployeeId String?
  status          String   @default("pending") // pending, approved, rejected
  reason          String?
  approvedBy      String?
  approvedAt      DateTime?
  createdAt       DateTime @default(now())
  requestedShift  Shift    @relation(fields: [requestedShiftId], references: [id])

  @@map("shift_swap_requests")
}

model ShiftRoster {
  id          String   @id @default(uuid())
  departmentId String?
  wardId      String?
  weekStartDate DateTime @db.Date
  weekEndDate  DateTime  @db.Date
  status      String   @default("draft") // draft, published
  publishedBy String?
  publishedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("shift_rosters")
}
// ===========================
// PACS (Picture Archiving and Communication System)
// ===========================

model RadiologyStudy {
  id                   String            @id @default(uuid())
  orderId              String
  patientId            String
  accessionNumber      String            @unique
  studyInstanceUID     String?           @unique
  modality             String            // CR, CT, MR, US, XR, etc.
  studyDate            DateTime
  studyDescription     String?
  referringPhysician   String?
  performingTechnician String?
  status               String            @default("scheduled") // scheduled, in_progress, completed, reported
  numberOfSeries       Int               @default(0)
  numberOfImages       Int               @default(0)
  storageSize          BigInt?           // bytes
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt
  order                Order             @relation(fields: [orderId], references: [id])
  patient              Patient           @relation(fields: [patientId], references: [id])
  series               RadiologySeries[]
  reports              RadiologyReport[]

  @@index([patientId])
  @@index([orderId])
  @@index([status])
  @@index([studyDate])
  @@map("radiology_studies")
}

model RadiologySeries {
  id                String           @id @default(uuid())
  studyId           String
  seriesInstanceUID String?
  seriesNumber      Int
  modality          String
  seriesDescription String?
  bodyPart          String?
  numberOfImages    Int              @default(0)
  createdAt         DateTime         @default(now())
  study             RadiologyStudy   @relation(fields: [studyId], references: [id], onDelete: Cascade)
  images            RadiologyImage[]

  @@index([studyId])
  @@map("radiology_series")
}

model RadiologyImage {
  id              String            @id @default(uuid())
  seriesId        String
  sopInstanceUID  String?
  instanceNumber  Int
  imageType       String?           // ORIGINAL, DERIVED
  filePath        String
  thumbnailPath   String?
  fileSize        Int
  rows            Int?
  columns         Int?
  bitsAllocated   Int?
  windowCenter    Float?
  windowWidth     Float?
  createdAt       DateTime          @default(now())
  series          RadiologySeries   @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  annotations     ImageAnnotation[]

  @@index([seriesId])
  @@map("radiology_images")
}

model ImageAnnotation {
  id          String         @id @default(uuid())
  imageId     String
  type        String         // text, arrow, circle, measurement, roi
  coordinates Json           // {x, y, width, height, points}
  label       String?
  color       String?
  createdBy   String
  createdAt   DateTime       @default(now())
  image       RadiologyImage @relation(fields: [imageId], references: [id], onDelete: Cascade)

  @@index([imageId])
  @@map("image_annotations")
}

model RadiologyReport {
  id              String         @id @default(uuid())
  studyId         String
  reportType      String         @default("final") // preliminary, final, addendum
  findings        String
  impression      String
  recommendations String?
  reportedBy      String
  verifiedBy      String?
  reportedAt      DateTime       @default(now())
  verifiedAt      DateTime?
  templateUsed    String?
  status          String         @default("draft") // draft, preliminary, final
  study           RadiologyStudy @relation(fields: [studyId], references: [id], onDelete: Cascade)

  @@index([studyId])
  @@index([status])
  @@map("radiology_reports")
}

model RadiologyReportTemplate {
  id        String   @id @default(uuid())
  name      String
  modality  String
  bodyPart  String?
  content   String   // template with placeholders
  isActive  Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())

  @@index([modality])
  @@map("radiology_report_templates")
}
model ReportTemplate {
  id          String           @id @default(uuid())
  tenantId    String
  name        String
  description String?
  category    String           // clinical, financial, operational, hr
  dataSource  String           // patients, appointments, billing, lab, etc.
  columns     Json             // [{field, label, type, aggregate}]
  filters     Json             // [{field, operator, defaultValue}]
  groupBy     Json?            // [field1, field2]
  sortBy      Json?            // [{field, direction}]
  chartType   String?          // bar, line, pie, table
  isSystem    Boolean          @default(false)
  isActive    Boolean          @default(true)
  createdBy   String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  schedules   ReportSchedule[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([category])
  @@map("report_templates")
}

model ReportSchedule {
  id         String         @id @default(uuid())
  templateId String
  frequency  String         // daily, weekly, monthly
  dayOfWeek  Int?           // 0-6 for weekly
  dayOfMonth Int?           // 1-31 for monthly
  time       String         // "08:00"
  recipients String[]       // email addresses
  format     String         @default("excel") // excel, pdf, csv
  filters    Json?          // override filters
  isActive   Boolean        @default(true)
  lastRunAt  DateTime?
  nextRunAt  DateTime?
  createdAt  DateTime       @default(now())
  template   ReportTemplate @relation(fields: [templateId], references: [id])

  @@index([isActive, nextRunAt])
  @@map("report_schedules")
}

model GeneratedReport {
  id          String   @id @default(uuid())
  tenantId    String
  templateId  String
  name        String
  parameters  Json     // filters used
  filePath    String?
  format      String
  rowCount    Int
  generatedBy String
  generatedAt DateTime @default(now())
  expiresAt   DateTime

  @@index([tenantId])
  @@index([generatedBy])
  @@index([expiresAt])
  @@map("generated_reports")
}

// ===========================
// BED RESERVATION SYSTEM
// ===========================

model BedReservation {
  id             String    @id @default(uuid())
  bedId          String
  patientId      String
  reservedFrom   DateTime
  reservedUntil  DateTime
  status         String    @default("active") // active, cancelled, completed
  admissionId    String?
  remarks        String?
  createdBy      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  bed            Bed       @relation(fields: [bedId], references: [id])
  patient        Patient   @relation(fields: [patientId], references: [id])

  @@index([bedId, status])
  @@index([patientId])
  @@index([reservedFrom, reservedUntil])
  @@map("bed_reservations")
}

// ===========================
// OPD SERVICES & BILLING
// ===========================

model Service {
  id           String   @id @default(uuid())
  tenantId     String
  branchId     String
  code         String
  name         String
  category     String   // consultation, procedure, lab, radiology, package, misc
  department   String?
  price        Decimal  @db.Decimal(10, 2)
  description  String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  tariffs      Tariff[]

  @@unique([tenantId, code])
  @@index([tenantId, branchId])
  @@index([category])
  @@index([isActive])
  @@map("services")
}

model Tariff {
  id            String   @id @default(uuid())
  tenantId      String
  branchId      String
  serviceId     String
  payerType     String   // cash, insurance, corporate, government
  payerName     String?  // specific payer name (e.g., insurance company)
  price         Decimal  @db.Decimal(10, 2)
  effectiveFrom DateTime @default(now())
  effectiveTo   DateTime?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  service       Service  @relation(fields: [serviceId], references: [id])

  @@index([tenantId, branchId])
  @@index([serviceId])
  @@index([payerType])
  @@index([isActive])
  @@map("tariffs")
}

model Refund {
  id            String   @id @default(uuid())
  tenantId      String
  branchId      String
  refundNumber  String
  invoiceId     String
  patientId     String
  amount        Decimal  @db.Decimal(10, 2)
  reason        String?
  remarks       String?
  items         Json?    // list of item IDs being refunded
  paymentMode   String   @default("cash") // cash, bank_transfer, original_method
  reference     String?
  status        String   @default("pending") // pending, approved, processed, rejected
  approvedBy    String?
  approvedAt    DateTime?
  processedBy   String?
  processedAt   DateTime?
  createdBy     String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([tenantId, refundNumber])
  @@index([tenantId, branchId])
  @@index([invoiceId])
  @@index([patientId])
  @@index([status])
  @@map("refunds")
}

model Doctor {
  id              String   @id @default(uuid())
  tenantId        String
  branchId        String
  userId          String?  // Link to User if they have system login
  employeeId      String   @unique
  name            String
  email           String?
  phone           String?
  specialty       String
  department      String
  designation     String?  // Senior Consultant, HOD, Junior Consultant, etc.
  gender          String?
  dateOfBirth     DateTime?
  dateOfJoining   DateTime?
  address         String?
  city            String?
  state           String?
  country         String?
  pinCode         String?
  experience      Int?     // Years of experience
  consultationFee Decimal? @db.Decimal(10, 2)
  followUpFee     Decimal? @db.Decimal(10, 2)
  emergencyFee    Decimal? @db.Decimal(10, 2)
  schedule        Json?    // {monday: {from: "09:00", to: "17:00"}, ...}
  availableSlots  Int      @default(20)
  slotDuration    Int      @default(15) // minutes per slot
  photo           String?
  signature       String?  // Digital signature image
  bio             String?
  languages       String[] // Languages spoken
  isActive        Boolean  @default(true)
  isOnLeave       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  qualifications  DoctorQualification[]
  licenses        DoctorLicense[]

  @@index([tenantId, branchId])
  @@index([department])
  @@index([specialty])
  @@index([isActive])
  @@map("doctors")
}

model DoctorQualification {
  id              String   @id @default(uuid())
  doctorId        String
  degree          String   // MBBS, MD, MS, DM, MCh, DNB, etc.
  specialization  String?  // Cardiology, Orthopedics, etc.
  institution     String   // University/College name
  university      String?  // Awarding university
  yearOfPassing   Int
  country         String   @default("India")
  certificateNo   String?
  certificateUrl  String?  // Uploaded certificate
  isVerified      Boolean  @default(false)
  verifiedBy      String?
  verifiedAt      DateTime?
  isPrimary       Boolean  @default(false) // Primary qualification to display
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  doctor          Doctor   @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
  @@index([degree])
  @@map("doctor_qualifications")
}

model DoctorLicense {
  id                String    @id @default(uuid())
  doctorId          String
  licenseType       String    // medical_council, state_council, specialty_board, etc.
  licenseNumber     String
  issuingAuthority  String    // Medical Council of India, State Medical Council, etc.
  issuingState      String?   // State if applicable
  issueDate         DateTime
  expiryDate        DateTime?
  renewalDate       DateTime?
  status            String    @default("active") // active, expired, suspended, revoked
  licenseUrl        String?   // Uploaded license document
  isVerified        Boolean   @default(false)
  verifiedBy        String?
  verifiedAt        DateTime?
  remarks           String?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  doctor            Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@unique([licenseType, licenseNumber])
  @@index([doctorId])
  @@index([status])
  @@index([expiryDate])
  @@map("doctor_licenses")
}

// ============================================
// CSSD (Central Sterilization Services Department)
// ============================================

model Instrument {
  id                String    @id @default(uuid())
  tenantId          String
  branchId          String
  instrumentCode    String    @unique
  name              String
  type              String    // surgical, dental, diagnostic, laboratory, etc.
  category          String    // scalpel, forceps, retractor, scissors, etc.
  manufacturer      String?
  model             String?
  serialNumber      String?
  purchaseDate      DateTime?
  purchasePrice     Decimal?  @db.Decimal(10, 2)
  lastSterilizedAt  DateTime?
  lastUsedAt        DateTime?
  nextMaintenanceAt DateTime?
  condition         String    @default("good") // good, fair, needs_repair, condemned
  status            String    @default("available") // available, in_use, sterilizing, maintenance, disposed
  location          String?   // Storage location
  notes             String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  sterilizationRecords InstrumentSterilization[]
  usageRecords         InstrumentUsage[]

  @@index([tenantId, branchId])
  @@index([type])
  @@index([status])
  @@index([lastSterilizedAt])
  @@map("cssd_instruments")
}

model SterilizationCycle {
  id                String    @id @default(uuid())
  tenantId          String
  branchId          String
  cycleNumber       String    @unique
  autoclaveName     String    // Autoclave A, B, etc.
  autoclaveId       String?
  operatorId        String
  operatorName      String
  cycleType         String    // gravity, prevacuum, flash, ETO, plasma, etc.
  loadType          String    // wrapped, unwrapped, mixed
  startTime         DateTime
  endTime           DateTime?
  temperature       Decimal   @db.Decimal(5, 2) // in Celsius
  temperatureUnit   String    @default("C")
  pressure          Decimal   @db.Decimal(5, 2) // in PSI or bar
  pressureUnit      String    @default("PSI")
  duration          Int       // in minutes
  status            String    @default("in_progress") // in_progress, completed, failed, aborted
  result            String?   // pass, fail, incomplete
  failureReason     String?
  biologicalIndicator Boolean @default(false)
  biologicalResult  String?   // positive, negative, pending
  chemicalIndicator Boolean   @default(false)
  chemicalResult    String?   // pass, fail
  notes             String?
  verifiedBy        String?
  verifiedAt        DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  instruments       InstrumentSterilization[]
  packs             SterilizationPack[]

  @@index([tenantId, branchId])
  @@index([status])
  @@index([result])
  @@index([startTime])
  @@map("cssd_sterilization_cycles")
}

model InstrumentSterilization {
  id              String   @id @default(uuid())
  instrumentId    String
  cycleId         String
  packId          String?
  position        String?  // Position in the autoclave load
  createdAt       DateTime @default(now())

  instrument      Instrument        @relation(fields: [instrumentId], references: [id])
  cycle           SterilizationCycle @relation(fields: [cycleId], references: [id])
  pack            SterilizationPack? @relation(fields: [packId], references: [id])

  @@index([instrumentId])
  @@index([cycleId])
  @@map("cssd_instrument_sterilizations")
}

model SterilizationPack {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  packCode        String    @unique
  packType        String    // general_surgery, ortho, dental, delivery, minor_procedure, etc.
  packName        String
  description     String?
  contents        Json      // [{instrumentId, name, quantity}]
  cycleId         String
  sterilizedAt    DateTime
  expiryDate      DateTime
  expiryDays      Int       @default(30) // Days until expiry from sterilization
  status          String    @default("available") // available, issued, used, expired, recalled
  issuedTo        String?   // Ward, OT, Department
  issuedAt        DateTime?
  issuedBy        String?
  usedFor         String?   // Surgery ID, Procedure ID
  usedAt          DateTime?
  usedBy          String?
  returnedAt      DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  cycle           SterilizationCycle @relation(fields: [cycleId], references: [id])
  instruments     InstrumentSterilization[]

  @@index([tenantId, branchId])
  @@index([status])
  @@index([expiryDate])
  @@index([packType])
  @@map("cssd_sterilization_packs")
}

model InstrumentUsage {
  id              String    @id @default(uuid())
  instrumentId    String
  usedBy          String    // User ID
  usedByName      String
  usedFor         String?   // Surgery ID, Procedure ID
  usedAt          DateTime  @default(now())
  returnedAt      DateTime?
  condition       String?   // Condition after use
  needsCleaning   Boolean   @default(true)
  needsRepair     Boolean   @default(false)
  notes           String?
  createdAt       DateTime  @default(now())

  instrument      Instrument @relation(fields: [instrumentId], references: [id])

  @@index([instrumentId])
  @@index([usedAt])
  @@map("cssd_instrument_usage")
}

// ============================================
// MRD (Medical Records Department)
// ============================================

model MedicalRecord {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  patientId       String
  encounterId     String?
  admissionId     String?
  recordType      String    // admission, discharge_summary, opd_note, lab_report, radiology, surgery, etc.
  recordCategory  String    // clinical, administrative, legal, research
  documentId      String?   // Link to Document model
  documentUrl     String?   // Direct URL if external
  title           String
  description     String?
  icdCodes        String[]  // ICD-10 codes
  cptCodes        String[]  // CPT procedure codes
  createdBy       String
  createdByName   String
  reviewedBy      String?
  reviewedByName  String?
  reviewedAt      DateTime?
  status          String    @default("active") // active, archived, restricted, deleted
  isConfidential  Boolean   @default(false)
  retentionYears  Int       @default(7) // Retention period in years
  archivedAt      DateTime?
  archivedBy      String?
  deletedAt       DateTime?
  deletedBy       String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  accessLogs      MRDAccessLog[]
  codingRecords   MRDCoding[]

  @@index([tenantId, branchId])
  @@index([patientId])
  @@index([encounterId])
  @@index([recordType])
  @@index([status])
  @@map("mrd_medical_records")
}

model MRDAccessLog {
  id              String   @id @default(uuid())
  medicalRecordId String
  userId          String
  userName        String
  accessType      String   // view, download, print, copy, edit, release
  accessReason    String?  // Treatment, billing, research, legal, audit
  ipAddress       String?
  userAgent       String?
  accessedAt      DateTime @default(now())

  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])

  @@index([medicalRecordId])
  @@index([userId])
  @@index([accessedAt])
  @@map("mrd_access_logs")
}

model MRDCoding {
  id              String   @id @default(uuid())
  medicalRecordId String
  codeType        String   // icd10, icd9, cpt, hcpcs, drg
  code            String
  description     String
  isPrimary       Boolean  @default(false)
  codedBy         String
  codedByName     String
  codedAt         DateTime @default(now())
  verifiedBy      String?
  verifiedAt      DateTime?
  notes           String?

  medicalRecord   MedicalRecord @relation(fields: [medicalRecordId], references: [id])

  @@index([medicalRecordId])
  @@index([codeType])
  @@index([code])
  @@map("mrd_coding")
}

model ICD10Code {
  code            String   @id
  shortDescription String
  longDescription String?
  category        String   // Chapter or category
  subcategory     String?
  isActive        Boolean  @default(true)

  @@index([category])
  @@map("mrd_icd10_codes")
}

model MRDArchive {
  id              String   @id @default(uuid())
  tenantId        String
  branchId        String
  archiveBatchId  String
  totalRecords    Int
  archivedBy      String
  archivedByName  String
  archivedAt      DateTime @default(now())
  archiveLocation String?  // Physical or digital storage location
  retentionUntil  DateTime
  status          String   @default("active") // active, destroyed
  destroyedAt     DateTime?
  destroyedBy     String?
  notes           String?

  @@index([tenantId, branchId])
  @@index([archiveBatchId])
  @@index([retentionUntil])
  @@map("mrd_archives")
}

model MRDReleaseRequest {
  id              String    @id @default(uuid())
  tenantId        String
  branchId        String
  patientId       String
  requestedBy     String
  requestedByName String
  requestedByType String    // patient, family, legal, insurance, employer, other
  relationship    String?   // Relationship to patient if not patient
  purpose         String    // treatment, legal, insurance, employment, research, personal
  recordTypes     String[]  // Types of records requested
  dateRange       Json?     // {from, to} - date range of records
  deliveryMethod  String    // email, mail, pickup, portal
  deliveryAddress String?
  email           String?
  phone           String?
  status          String    @default("pending") // pending, approved, partially_approved, denied, completed
  reviewedBy      String?
  reviewedByName  String?
  reviewedAt      DateTime?
  completedBy     String?
  completedAt     DateTime?
  denialReason    String?
  authorizationDoc String?  // Uploaded authorization document
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([tenantId, branchId])
  @@index([patientId])
  @@index([status])
  @@map("mrd_release_requests")
}

// ============================================
// User Two-Factor Authentication
// ============================================

model UserTwoFactor {
  id              String    @id @default(uuid())
  userId          String    @unique
  method          String    // totp, sms, both
  totpSecret      String?   // Encrypted TOTP secret
  totpVerified    Boolean   @default(false)
  smsEnabled      Boolean   @default(false)
  smsPhone        String?
  backupCodes     String[]  // Hashed backup codes
  enabledAt       DateTime?
  lastUsedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("user_two_factor")
}
